<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper
	namespace="kr.or.ddit.pfcp.staff.programStatistics.mapper.ProgramStatisticsMapper">

	<select id="selectTodayStatistics"
		resultType="kr.or.ddit.pfcp.common.vo.ProgramStatisticsVO">
		SELECT
		STAT_DATE
		, TOTAL_PROGRAMS
		, TOTAL_APPLICANTS
		, MONTHLY_APPLY
		, COMPLETE_RATE
		, REG_DATE
		FROM PROGRAM_STATISTICS
		WHERE
		STAT_DATE = TRUNC(SYSDATE)
	</select>

	<select id="countAllPrograms" resultType="int">
		SELECT COUNT(*) FROM
		PROGRAM
		WHERE PROGRAM_ACTIVE != 'D'
	</select>

	<select id="countAllApplicants" resultType="int">
		SELECT COUNT(*) FROM
		PROGRAM_ENROLL
	</select>

	<select id="countThisMonthApplicants" resultType="int">
		SELECT COUNT(*)
		FROM PROGRAM_ENROLL
		WHERE TO_CHAR(TO_DATE(APPLY_DATE, 'YYYY-MM-DD'),
		'YYYY-MM') =
		TO_CHAR(SYSDATE, 'YYYY-MM')
		AND IS_ATTENDED = 'Y'
	</select>


	<select id="calculateCompleteRate" resultType="int">
		SELECT
		CASE
		WHEN
		total = 0 THEN 0
		ELSE ROUND(complete * 100 / total)
		END AS COMPLETE_RATE
		FROM (
		SELECT
		(SELECT COUNT(*) FROM PROGRAM WHERE PROGRAM_ACTIVE = 'C')
		AS complete
		, (SELECT COUNT(*) FROM PROGRAM) AS total
		FROM DUAL
		)
	</select>


	<insert id="insertStatistics"
		parameterType="kr.or.ddit.pfcp.common.vo.ProgramStatisticsVO">
		MERGE INTO PROGRAM_STATISTICS PS
		USING DUAL
		ON (PS.STAT_DATE = TO_DATE(#{statDate}, 'YYYY-MM-DD'))
		WHEN MATCHED THEN
		UPDATE SET
		TOTAL_PROGRAMS = #{totalPrograms},
		TOTAL_APPLICANTS = #{totalApplicants},
		MONTHLY_APPLY = #{monthlyApply},
		COMPLETE_RATE = #{completeRate}
		WHEN NOT MATCHED THEN
		INSERT (
		STAT_NO,
		STAT_DATE,
		TOTAL_PROGRAMS,
		TOTAL_APPLICANTS,
		MONTHLY_APPLY,
		COMPLETE_RATE,
		REG_DATE
		) VALUES (
		'STATIS' || LPAD(STAT_NO_SEQ.NEXTVAL, 6, '0'),
		TO_DATE(#{statDate}, 'YYYY-MM-DD'),
		#{totalPrograms},
		#{totalApplicants},
		#{monthlyApply},
		#{completeRate},
		SYSDATE
		)
	</insert>
	
	<!--유형별 프로그램 신청자 수  -->
	<select id="selectTodayTypeApplyStats" resultType="kr.or.ddit.pfcp.common.vo.ProgramTypeStatVO">
		SELECT
			P.TYPE_CODE AS typeCode
			, COUNT(E.ENROLL_NO) AS applyCount
		FROM PROGRAM P
		LEFT JOIN 
			PROGRAM_ENROLL E ON P.PROGRAM_NO = E.PROGRAM_NO
		GROUP BY P.TYPE_CODE
	</select>
	
	<!--유형별 프로그램 개수  -->
	<select id="selecteProgramBytypeCount" resultType="kr.or.ddit.pfcp.common.vo.ProgramTypeStatVO">
		SELECT TYPE_CODE, COUNT(*) AS COUNT
		FROM PROGRAM
		WHERE PROGRAM_ACTIVE = 'Y'
		GROUP BY TYPE_CODE
	</select>
	
	<!-- 유형별 프로그램 insert  -->

	<insert id="insertTypeStat"
		parameterType="kr.or.ddit.pfcp.common.vo.ProgramTypeStatVO">
		MERGE INTO PROGRAM_TYPE_STATISTICS PTS
		USING DUAL
		ON (
		PTS.TYPE_CODE = #{typeCode}
		AND PTS.STAT_DATE = TO_DATE(#{statDate}, 'YYYY-MM-DD')
		AND PTS.STAT_GROUP = #{statGroup}
		)
		WHEN MATCHED THEN
		UPDATE SET
		APPLY_COUNT = #{applyCount}
		WHEN NOT MATCHED THEN
		INSERT (
		TYPE_STAT_NO,
		TYPE_CODE,
		APPLY_COUNT,
		STAT_DATE,
		STAT_GROUP
		) VALUES (
		'PTSTAT' || LPAD(TYPE_STAT_NO_SEQ.NEXTVAL, 6, '0'),
		#{typeCode},
		#{applyCount},
		TO_CHAR(SYSDATE, 'YYYY/MM/DD'),
		#{statGroup}
		)
	</insert>
	
	<select id="selectTypeStat"
		resultType="kr.or.ddit.pfcp.common.vo.ProgramTypeStatVO">
		SELECT
			TYPE_CODE,
			SUM(APPLY_COUNT) AS APPLY_COUNT
		FROM PROGRAM_TYPE_STATISTICS
		WHERE STAT_DATE = TRUNC(SYSDATE)
		GROUP BY TYPE_CODE
	</select>
	
	
		
	
		
	
	

</mapper>