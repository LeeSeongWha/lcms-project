<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.or.ddit.pfcp.professor.attendclass.mapper.ProfessorAttendClassMapper">
 <resultMap id="lecReqResultMap" type="LectureReqVO">
        <id property="reqNo" column="REQ_NO"/>
        <result property="subjectName" column="SUBJECT_NAME"/>
        <result property="userName" column="USER_NAME"/>
        <result property="lecName" column="LEC_NAME"/>
        <result property="lecCategory" column="LEC_CATEGORY"/>
        <result property="preDay" column="PRE_DAY"/>
        <result property="preTime" column="PRE_TIME"/>
        <result property="preClassrm" column="PRE_CLASSRM"/>
        <result property="maxCapacity" column="MAX_CAPACITY"/>
        <result property="reqDate" column="REQ_DATE"/>
        <result property="fileRefNo" column="FILE_REF_NO"/>
        <result property="status" column="STATUS"/>
        <result property="lecNo" column="LEC_NO"/>
        <association property="atchFile" javaType="kr.or.ddit.pfcp.common.vo.AtchFileVO">
            <id property="atchId" column="ATCH_ID"/>
            <result property="atchOriginName" column="ATCH_ORIGIN_NAME"/>
            </association>
    </resultMap>

    <resultMap id="lectureEnrResultMap" type="kr.or.ddit.pfcp.common.vo.LectureEnrVO">
        <result property="userNo" column="USER_NO"/>
        <result property="userName" column="USER_NAME"/>
        <result property="collegeName" column="COLLEGE_NAME"/>
        <result property="departmentName" column="DEPARTMENT_NAME"/>
        <result property="enrollNo" column="ENROLL_NO"/>
        <result property="lecNo" column="LEC_NO_ENR"/> <result property="enrollTime" column="ENROLL_TIME"/>
        <result property="enrollStatus" column="ENROLL_STATUS"/>
        <result property="enrollType" column="ENROLL_TYPE"/>
        <result property="priority" column="PRIORITY"/>
        <result property="attendance" column="ATTENDANCE"/>
        <result property="evalYn" column="EVAL_YN"/>
        <result property="grade" column="GRADE"/>
        <result property="gradePoint" column="GRADE_POINT"/>
        <result property="subjectName" column="SUBJECT_NAME_ENR"/> <result property="preDay" column="PRE_DAY"/>
        <result property="preTime" column="PRE_TIME"/>
        <result property="professorName" column="PROFESSOR_NAME"/>
    </resultMap>

    <select id="selectEnrPagingKeyword" resultType="LectureEnrVO">
	    SELECT * FROM (
	        SELECT ROWNUM AS RNUM, E.*
	        FROM (
	            SELECT 
	            	LE.ENROLL_NO,
	                LE.USER_NO, 
	                U.USER_NAME, 
	                U.USER_EMAIL, 
	                U.USER_TEL,
	                COL.COLLEGE_NAME,               
	                DEP.DEPARTMENT_NAME             
	            FROM LECTURE_ENR LE
	            JOIN TB_USER U ON LE.USER_NO = U.USER_NO
	            JOIN STUDENT STU ON U.USER_NO = STU.USER_NO
	            JOIN DEPARTMENT DEP ON STU.DEPARTMENT_NO = DEP.DEPARTMENT_NO
	            JOIN COLLEGE COL ON DEP.COLLEGE_NO = COL.COLLEGE_NO
	            WHERE LE.LEC_NO = #{lecNo}
	            <if test="keyword != null and keyword != ''">
	                <choose>
	                    <when test="searchType == 'userNo'">
	                        AND LE.USER_NO LIKE '%' || #{keyword} || '%'
	                    </when>
	                    <when test="searchType == 'userName'">
	                        AND U.USER_NAME LIKE '%' || #{keyword} || '%'
	                    </when>
	                    <otherwise>
	                        AND (LE.USER_NO LIKE '%' || #{keyword} || '%' 
	                         OR U.USER_NAME LIKE '%' || #{keyword} || '%')
	                    </otherwise>
	                </choose>
	            </if>
	            ORDER BY LE.USER_NO ASC
	        ) E
	        WHERE ROWNUM &lt;= #{offset} + #{limit}
	    )
	    WHERE RNUM &gt; #{offset}
	</select>
	
	<select id="selectCntEnrKeyword" resultType="int">
	    SELECT COUNT(*)
	    FROM LECTURE_ENR LE
	    JOIN TB_USER U ON LE.USER_NO = U.USER_NO
	    WHERE LE.LEC_NO = #{lecNo}
	    <if test="keyword != null and keyword != ''">
	        <choose>
	        	<when test="searchType == null or searchType == '' or searchType == 'all'">
	                AND (U.USER_NAME LIKE '%' || #{keyword} || '%' OR LE.USER_NO LIKE '%' || #{keyword} || '%')
	            </when>
	            <when test="searchType == 'userNo'">
				    AND LE.USER_NO LIKE '%' || #{keyword} || '%'
				</when>
	            <when test="searchType == 'userName'">
	                AND U.USER_NAME LIKE '%' || #{keyword} || '%'
	            </when>
	            <otherwise>
	                AND (LE.USER_NO LIKE '%' || #{keyword} || '%' 
	                 OR U.USER_NAME LIKE '%' || #{keyword} || '%')
	            </otherwise>
	        </choose>
	    </if>
	</select>

</mapper>