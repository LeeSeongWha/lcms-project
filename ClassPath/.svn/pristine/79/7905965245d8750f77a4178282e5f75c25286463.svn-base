<%-- 
 * == 개정이력(Modification Information) ==
 * 수정일      수정자   수정내용
 * ========================================
 * 2025-07-17   양수민   최초 생성 
--%>
<%@ page language="java" contentType="text/html; charset=UTF-8"
    pageEncoding="UTF-8"%>
<%@ taglib uri="jakarta.tags.core" prefix="c"%>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<title>증명서 목록</title>
<link rel="stylesheet" href="/dist/assets/css/bodyFormat.css">
<link rel="stylesheet" href="/dist/assets/css/staff/certificationList.css">

<div class="sectionHeaderLine">
    <div>
        <div class="sectionHeaderTitle">증명서 목록</div>
        <div class="sectionHeaderDescription">전체 ${totalCount}개의 증명서</div>
    </div>
</div>

<div class="lecture-list-container-flex">
    <div class="lecture-list-left">
        <c:set var="displayedCount" value="0" />
        <c:choose>
            <c:when test="${not empty certificationList}">
                <c:forEach items="${certificationList}" var="certification" varStatus="status">
                    <div class="college-item-card lecture-item-link"
                         data-cert-code="${certification.certCode}"
                         data-file-ref-no="${certification.fileRefNo}">
                         <input value="${certification.fileRefNo}">
                        <div class="lecture-info-group">
                            <div>
                                <span class="lecture-name">${certification.certName}</span>
                                <p class="lecture-details">・ 증명서 번호: ${certification.certCode}</p>
                                <p class="lecture-details">・ ${certification.certDesc}</p>
                                <p class="lecture-details">・ 발급 수수료: ${certification.issueFee}</p>
                            </div>
                        </div>
                    </div>
                    <c:set var="displayedCount" value="${displayedCount + 1}" />
                </c:forEach>
            </c:when>
        </c:choose>

        <div class="college-item-card add-college-card" data-cert-code="add-new">
            <div class="lecture-info-group">
                <div class="lecture-icon-wrapper">
                    <svg xmlns="http://www.w3.org/2000/svg" class="lecture-icon"
                         fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round"
                              stroke-width="2.5" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                    </svg>
                </div>
            </div>
        </div>

        <c:if test="${displayedCount == 0}">
            <div class="no-lecture-message">증명서 목록이 존재하지 않습니다.</div>
        </c:if>
    </div>

    <div class="lecture-details-right card">
        <div id="certificationPdfArea">
            <div class="detail-placeholder">증명서를 선택하면 증명서PDF 예시가 여기에 표시됩니다.</div>
        </div>
    </div>
</div>

<script>
let isEditMode = false;
let currentCertCode = "";
let currentFileRefNo = "";

function toggleEditMode() {
    isEditMode = true;
    document.getElementById("uploadFile").style.display = "block";
    document.getElementById("editButton").style.display = "none";
    document.getElementById("submitButton").style.display = "inline-block";
    document.getElementById("cancelButton").style.display = "inline-block";
}


function cancel() {
    isEditMode = false;
    document.getElementById("uploadFile").style.display = "none";
    document.getElementById("editButton").style.display = "inline-block";
    document.getElementById("submitButton").style.display = "none";
    document.getElementById("cancelButton").style.display = "none";
}

function filesubmit() {
    const file = $("#uploadFile")[0].files[0];
    const fileRefNo = $("file-ref-no"); 
    if (!file) {
        alert("업로드할 파일을 선택해주세요!");
        return;
    }

    const formData = new FormData();
    formData.append("uploadFile", file);
    formData.append("certCode", currentCertCode);
    
    console.log("uploadFile", file);
    console.log("certCode", currentCertCode);

    $.ajax({
        url: "/staff/certification/certificationFormInsertProcess.do",
        type: "POST",
        data: formData,
        processData: false,
        contentType: false,
        success: function () {
            alert("파일이 성공적으로 저장되었습니다.");
            location.reload();
        },
        error: function () {
            alert("파일 저장 중 오류가 발생했습니다.");
        }
    });

    cancel();
}

$(document).ready(function () {
    $(".college-item-card").on("click", function () {
    	
        const certCode = $(this).data("cert-code");
        const fileRefNo = $(this).data("file-ref-no");

        console.log("클릭한 certCode:", certCode);

        if (!certCode) {
            alert("증명서 코드가 없습니다.");
            return;
        }
        
        if (certCode === "add-new") return;

        currentCertCode = certCode;
        currentFileRefNo = fileRefNo;

        $(".college-item-card").removeClass("active");
        $(this).addClass("active");

        isEditMode = false;
        $("#certificationPdfArea").html('<div class="detail-placeholder">PDF를 불러오는 중...</div>');

        let pdfUrl = `/staff/certification/serveCertificationFormPdf.do?certCode=` + certCode;
        console.log("pdfUrl:", pdfUrl);
        if (fileRefNo) {
            pdfUrl += `&fileRefNo=${fileRefNo}`;
        }

        $.ajax({
            url: pdfUrl,
            type: 'GET',
            xhrFields: { responseType: 'blob' },
            success: function (blob) {
                const pdfObjectUrl = URL.createObjectURL(blob);
                const iframeHtml = `
                    <div class="sectionHeaderLine">
                        <div>
                            <div class="sectionHeaderTitle">증명서 PDF 폼</div>
                        </div>
                        <button id="editButton" class="editButton" style="float:right;">수정</button>
//                         <button id="submitButton" class="submitButton" style="float:right; display:none;">저장</button>
//                         <button id="cancelButton" class="cancelButton" style="float:right; display:none;">취소</button>
                    </div>
                    <input type="file" id="uploadFile" name="uploadFile" class="form-control" style="display:none; margin: 15px 0;">
                    <iframe src="${pdfObjectUrl}" width="100%" height="800px" frameborder="0"></iframe>
                `;
                
                
                $("#certificationPdfArea").html(iframeHtml);
                
                console.log("iframeHtml =", iframeHtml);
            },
            error: function () {
                const errorHtml = `
                	<div class="sectionHeaderLine">
                    <div>
                        <div class="sectionHeaderTitle">증명서 PDF 폼</div>
                    </div>
                    <button id="editButton" class="editButton" style="float:right;" onclick="toggleEditMode()">수정</button>
	                    <button id="submitButton" class="submitButton" style="float:right; display:none;" onclick="filesubmit()">저장</button>
	                    <button id="cancelButton" class="cancelButton" style="float:right; display:none;" onclick="cancel()">취소</button>
	                </div>
	                <input type="file" id="uploadFile" name="uploadFile" class="form-control" style="display:none; margin: 15px 0;">
                    <img src="/dist/assets/errorImg/fileLoadFail.png" alt="파일을 불러오는 데 실패했습니다." class="error-image">
                    <div class="error-message">파일을 불러오는 데 실패했습니다. 다시 시도해 주세요.</div>
                `;
                $("#certificationPdfArea").html(errorHtml);
            }
        });
    });

});
</script>

<style>
.error-message {
    margin-top: 20px;
    font-size: 1.2em;
    color: #333;
    text-align: center;
}
.error-image {
    display: block;
    margin: 20px auto;
    max-width: 80%;
    height: auto;
    border: 1px solid #ddd;
    box-shadow: 2px 2px 8px rgba(0,0,0,0.1);
}
</style>
