<%@ page contentType="text/html; charset=UTF-8"%>
<%@ taglib prefix="c" uri="jakarta.tags.core"%>
<%@ taglib prefix="form" uri="http://www.springframework.org/tags/form"%>
<!DOCTYPE html>
<html>
<head>
<title>ë¹„êµê³¼ í”„ë¡œê·¸ë¨ ê´€ë¦¬</title>
<link rel="stylesheet" href="/dist/assets/css/bodyFormat.css" />
<link rel="stylesheet" href="/dist/assets/css/attendclass.css">
<link rel="stylesheet" href="/dist/assets/css/staff/programChart.css">
<script>
   
document.addEventListener("DOMContentLoaded", function () {
     document.querySelectorAll('[data-tab]').forEach(tab => {
       tab.addEventListener('click', function () {
         const selected = this.dataset.tab;

         // íƒ­ í™œì„±í™” ì²˜ë¦¬
         document.querySelectorAll('.tab').forEach(btn => btn.classList.remove('active'));
         this.classList.add('active');

         // ì½˜í…ì¸  ë³´ì´ê¸° ì²˜ë¦¬
         document.querySelectorAll('[data-tab-content]').forEach(div => {
           div.style.display = div.dataset.tabContent === selected ? 'block' : 'none';
         });

        /*  //  ì‹ ì²­ ê´€ë¦¬ íƒ­ í´ë¦­ ì‹œ 
         if (selected === 'apply') {
           loadProgramEnrollList({ page: 1 });
         } */
       });
     });
   });
function goToApplyPage(programNo) {
   location.href = '/staff/program/apply/' + programNo;
}

function goToDetail(programNo) {
     location.href = '/staff/program/edit/' + programNo;
}

function deleteProgram(programNo) {
     if (!confirm("ì •ë§ ì´ í”„ë¡œê·¸ë¨ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

     fetch('/staff/program/delete/' + programNo, {
       method: 'Delete'
     })
     .then(res => {
       if (res.ok) {
         alert("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
         location.reload();
       } else {
         alert("ì‚­ì œ ì‹¤íŒ¨");
       }
     })
     .catch(() => alert("ì„œë²„ ì˜¤ë¥˜"));
}
function loadFeedbackList() {
	  fetch("/feedbackList")
	    .then(res => res.json())
	    .then(list => {
	      const container = document.getElementById("feedbackListContainer");
	      container.innerHTML = "";

	      if (list.length === 0) {
	        container.innerHTML = "<p style='text-align:center;'>ë“±ë¡ëœ í”¼ë“œë°±ì´ ì—†ìŠµë‹ˆë‹¤.</p>";
	        return;
	      }

	      list.forEach(fb => {
	        const starHTML = [...Array(5).keys()].map(i =>
	          `<span class="${i < fb.feedbackAccount ? 'star filled' : 'star'}">â˜…</span>`
	        ).join("");

	        container.innerHTML += `
	          <div class="feedback-card">
	            <div class="feedback-header">
	              <div class="program-title">${fb.program.programTitle}</div>
	              <div class="star-rating">${starHTML}</div>
	            </div>
	            <div class="feedback-content">${fb.feedbackComment}</div>
	            <div class="feedback-footer">
	              <span>${fb.user.userName}</span>
	              <span>${fb.submitDate}</span>
	            </div>
	          </div>
	        `;
	      });
	    });
	}


</script>

</head>
<body>
	<div class="container">
		<h1>ë¹„êµê³¼ í”„ë¡œê·¸ë¨ ê´€ë¦¬ ì‹œìŠ¤í…œ</h1>
		<%-- <p class="stat-update-time">
         ë§ˆì§€ë§‰ ê°±ì‹  ì‹œê°: <strong>${stat.regDate}</strong>
      </p> --%>


		<div class="summary-grid">
			<div>
				ì „ì²´ í”„ë¡œê·¸ë¨<span>${liveStat.totalPrograms }</span>
			</div>
			<div>
				ì´ ì°¸ì—¬ì ìˆ˜<span>${liveStat.totalApplicants }</span>
			</div>
			<div>
				ì´ë²ˆ ë‹¬ ì‹ ì²­ ìˆ˜<span>${liveStat.monthlyApply }</span>
			</div>
			<div>
				ì™„ë£Œìœ¨<span>${liveStat.completeRate }%</span>
			</div>
		</div>

		<div class="tab-menu">
			<button data-tab="program" class="tab active">í”„ë¡œê·¸ë¨ ê´€ë¦¬</button>
			<button data-tab="apply" class="tab">ì‹ ì²­ ê´€ë¦¬</button>
			<!--          <button data-tab="followup" class="tab">ì‚¬í›„ ê´€ë¦¬</button> -->
			<button data-tab="statistics" class="tab">í†µê³„ ë¶„ì„</button>
			<button data-tab="survey" class="tab">ì„¤ë¬¸ ê´€ë¦¬</button>

		</div>


		<!--ë¹„êµê³¼ í”„ë¡œê·¸ë¨ ê´€ë¦¬ íƒ­  -->
		<div class="tab-content" data-tab-content="program"
			style="display: block;">
			<h3>ë¹„êµê³¼ í”„ë¡œê·¸ë¨ ê´€ë¦¬</h3>
			<div class="add-button">

				<button type="button" class="btn-add"
					onclick="location.href='/staff/program/form'">ìƒˆ í”„ë¡œê·¸ë¨ ì¶”ê°€</button>
			</div>
			<table>
				<thead>
					<tr>
						<th>í”„ë¡œê·¸ë¨ëª…</th>
						<th>ê¸°ê°„</th>
						<th>ìƒíƒœ</th>
						<th>ìœ í˜•</th>
						<th>ì •ì›</th>
						<th>ì¥ì†Œ</th>
						<th>ê´€ë¦¬</th>
					</tr>
				</thead>
				<tbody>
					<c:forEach var="p" items="${programList}">
						<tr class="ahover">
							<td onclick="goToDetail('${p.programNo}')">${p.programTitle}</td>
							<td onclick="goToDetail('${p.programNo}')">${p.startDate}~${p.endDate}</td>
							<td onclick="goToDetail('${p.programNo}')"><c:choose>
									<c:when test="${p.programActive eq 'N'}">
                              ëª¨ì§‘ì¤‘
                           </c:when>
									<c:when test="${p.programActive eq 'Y'}">
                              ì§„í–‰ì¤‘
                           </c:when>
									<c:when test="${p.programActive eq 'C'}">
                              ì™„ë£Œ
                           </c:when>
								</c:choose></td>
							<td onclick="goToDetail('${p.programNo}')">${p.type.typeName }</td>
							<td onclick="goToDetail('${p.programNo}')">${p.programCapacity }</td>
							<td onclick="goToDetail('${p.programNo}')">${p.place }</td>
							<td>
								<button onclick="deleteProgram('${p.programNo}')" title="ì‚­ì œ"
									style="background: none; border: none; cursor: pointer;">
									ğŸ—‘</button>
							</td>
						</tr>
					</c:forEach>
				</tbody>
			</table>
		</div>


		<div class="tab-content" data-tab-content="apply"
			style="display: none;">
			<div class="section">
				<div class="sectionHeaderLine">
					<div>
						<div class="sectionHeaderTitle">ë¹„êµê³¼ í”„ë¡œê·¸ë¨ ì‹ ì²­ ê´€ë¦¬</div>
					</div>
				</div>

				<div class="lecture-list-container">
					<c:set var="displayedCount" value="0" />
					<c:choose>
						<c:when test="${not empty openProgramList}">
							<c:forEach var="p" items="${openProgramList}">
								<c:url value="/staff/program/apply/${p.programNo}"
									var="detailURL" />
								<a href="${detailURL}" class="lecture-item-link">
									<div class="lecture-item-content">
										<div class="lecture-info-group">
											<div class="lecture-icon-wrapper">
												<svg xmlns="http://www.w3.org/2000/svg" class="lecture-icon"
													fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                 <path stroke-linecap="round"
														stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                              </svg>
											</div>
											<div>
												<span class="lecture-name">${p.programTitle}</span>
												<p class="lecture-details">
													ãƒ» í”„ë¡œê·¸ë¨ ë²ˆí˜¸: ${p.programNo}<br> ãƒ» ìœ í˜•: ${p.type.typeName}<br>
													ãƒ» ê¸°ê°„: ${p.startDate} ~ ${p.endDate}<br> ãƒ» ì •ì›:
													${p.programCapacity}ëª…
												</p>
											</div>
										</div>
									</div>
								</a>
								<c:set var="displayedCount" value="${displayedCount + 1}" />
							</c:forEach>
						</c:when>
					</c:choose>

					<c:if test="${displayedCount == 0}">
						<div class="no-lecture-message">ëª¨ì§‘ ì¤‘ì¸ ë¹„êµê³¼ í”„ë¡œê·¸ë¨ì´ ì—†ìŠµë‹ˆë‹¤.</div>
					</c:if>
				</div>
			</div>
		</div>

		<div class="tab-content" data-tab-content="statistics"
			style="display: none;">

			<!-- ê¸°ì¡´ í†µê³„ ê°œìš” + donut ì°¨íŠ¸ë¥¼ í•˜ë‚˜ì˜ í–‰ìœ¼ë¡œ ê°ì‹¸ê¸° -->
			<div class="chart-row">
				<div class="chart-box">
					<h4 class="chart-title">ğŸ“Š í†µê³„ ê°œìš”</h4>
					<canvas id="programStatChart" width="300" height="250"></canvas>
					<p class="chart-desc">
						âœ… ì „ì²´ ì´ìˆ˜ìœ¨: <strong>${stat.completeRate}%</strong>
					</p>
				</div>

				<div class="chart-box">
					<h4 class="chart-title">ğŸ“Š ìœ í˜•ë³„ ì‹ ì²­ì í†µê³„</h4>
					<canvas id="donutChart" width="300" height="250"></canvas>
				</div>
			</div>

			<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
			<script>
             const barCtx = document.getElementById('programStatChart').getContext('2d');
         
             new Chart(barCtx, {
               type: 'bar',
               data: {
                 labels: ['ì „ì²´ í”„ë¡œê·¸ë¨ ìˆ˜', 'ì „ì²´ ì‹ ì²­ì ìˆ˜', 'ë‹¹ì›” ì‹ ì²­ì ìˆ˜'],
                 datasets: [{
                   label: '${stat.statDate} ê¸°ì¤€ í†µê³„',
                   data: [${stat.totalPrograms}, ${stat.totalApplicants}, ${stat.monthlyApply}],
                   backgroundColor: ['#4e79a7', '#f28e2b', '#e15759'],
                   borderColor: ['#4e79a7', '#f28e2b', '#e15759'],
                   borderWidth: 1,
                   borderRadius: 5
                 }]
               },
               options: {
                 responsive: true,
                 plugins: {
                   legend: {
                     display: true,
                     position: 'bottom',
                     labels: {
                       font: { size: 12 },
                       color: '#333'
                     }
                   },
                   title: {
                     display: false
                   },
                   tooltip: {
                     backgroundColor: '#333',
                     titleFont: { weight: 'bold' },
                     bodyFont: { size: 13 },
                     padding: 10
                   }
                 },
                 scales: {
                   y: {
                     beginAtZero: true,
                     grid: {
                       color: '#eee'
                     },
                     ticks: {
                       stepSize: 1,
                       font: { size: 12 }
                     }
                   },
                   x: {
                     ticks: {
                       font: { size: 12 }
                     }
                   }
                 }
               }
             });
           </script>


			<script>
           fetch("/staff/program/donut/data")
             .then(response => response.json())
             .then(data => {
               const labels = data.map(d => d.typeCode);
               const values = data.map(d => d.applyCount);
         
               const ctx = document.getElementById('donutChart').getContext('2d');
               new Chart(ctx, {
                 type: 'doughnut',
                 data: {
                   labels: labels,
                   datasets: [{
                     label: 'ì‹ ì²­ì ìˆ˜',
                     data: values,
                     backgroundColor: [
                       '#4e79a7', '#f28e2b', '#e15759', '#76b7b2',
                       '#59a14f', '#edc948', '#b07aa1', '#ff9da7'
                     ],
                     borderWidth: 1
                   }]
                 },
                 options: {
                   responsive: true,
                   plugins: {
                     legend: {
                       position: 'bottom'
                     },
                     title: {
                       display: false
                     }
                   }
                 }
               });
             });
      </script>



		</div>
		<div class="tab-content" data-tab-content="survey"
			style="display: none;">
			<div class="survey-summary-grid">
				<!-- ì¢Œì¸¡: í”¼ë“œë°± ì¹´ë“œ -->
				<div class="feedback-card-wrapper">
					<h4>ğŸ’¬ í”¼ë“œë°± ê´€ë¦¬</h4>
					<div id="feedbackListContainer"></div>
				</div>

				<!-- ìš°ì¸¡: ë§Œì¡±ë„ í†µê³„ -->
				<div class="satisfaction-chart-wrapper">
					<h4>ğŸ“‹ ë§Œì¡±ë„ ì¡°ì‚¬</h4>
					<div class="total-score" id="totalScoreBox"></div>
					<div id="satisfactionChartBox"></div>
				</div>
			</div>
		</div>

	</div>
</body>
</html>



