<%@ page language="java" contentType="text/html; charset=UTF-8"
pageEncoding="UTF-8"%> 
<%@ taglib prefix="sec" uri="http://www.springframework.org/security/tags" %>
<%@ taglib uri="jakarta.tags.core" prefix="c"%>

<link rel="stylesheet" href="/dist/assets/css/sidebar-specific.css">

<div class="sidebar"> 
	<div class="sidebar-logo">
		<!-- Logo Header -->
		<div class="logo-header" style="background-color:#203A8A">
			<a href="/" class="logo"> 
				<img src="/dist/assets/img/kaiadmin/logo_pathFinder_white.png"
					 alt="navbar brand" class="navbar-brand" height="50" width="150" />
			</a>
			<div class="nav-toggle">
				<button class="btn btn-toggle toggle-sidebar">
					<i class="gg-menu-right"></i>
				</button>
				<button class="btn btn-toggle sidenav-toggler">
					<i class="gg-menu-left"></i>
				</button>
			</div>
			<button class="topbar-toggler more">
				<i class="gg-more-vertical-alt"></i>
			</button>
		</div>
	</div>
	
	<!-- Role Selector - 관리자나 특정 권한을 가진 사용자만 보이게 -->
	<sec:authorize access="hasRole('ADMIN') or hasRole('SUPER_ADMIN')">
		<div class="role-selector" style="padding: 15px;">
			<label for="roleSelector" class="visually-hidden">Select Role</label>
			<select id="roleSelector" class="form-select">
				<option value="staff">교직원</option>
				<option value="student">학생</option>
				<option value="professor">교수</option>
			</select>
		</div>
	</sec:authorize>
	
	<div class="sidebar-wrapper scrollbar scrollbar-inner">
		<div class="sidebar-content">
			
			<!-- Staff Menu - 교직원 권한을 가진 사용자만 보이게 -->
			<sec:authorize access="hasRole('STAFF')">
				<ul class="nav nav-secondary" id="staffMenu">
					<li class="nav-item">
						<a data-bs-toggle="collapse" href="#memberManagement" class="collapsed" aria-expanded="false">
							<i class="fas fa-users"></i>
							<p>구성원관리</p>
							<span class="caret"></span>
						</a>
						<div class="collapse" id="memberManagement">
							<ul class="nav nav-collapse">
								<li class="nav-item">
									<a href="/staff/studentmanage/studentList.do">
										<span class="sub-item">학생관리</span>
									</a>
								</li>
								<li class="nav-item">
									<a href="/staff/professorManagement/professorList.do">
										<span class="sub-item">교수관리</span>
									</a>
								</li>
								<li class="nav-item">
									<a href="/staff/staffmanage/staffmanageList.do">
										<span class="sub-item">교직원관리</span>
									</a>
								</li>
							</ul>
						</div>
					</li>
					
					<li class="nav-item">
						<a data-bs-toggle="collapse" href="#classManagement" class="collapsed" aria-expanded="false">
							<i class="fas fa-chalkboard"></i>
							<p>수업관리</p>
							<span class="caret"></span>
						</a>
						<div class="collapse" id="classManagement">
							<ul class="nav nav-collapse">
								<li class="nav-item">
									<a href="/staff/subject/subjectList.do">
										<span class="sub-item">교과목관리</span>
									</a>
								</li>
								<li class="nav-item">
									<a href="/staff/grademanage/gradeList.do">
										<span class="sub-item">성적관리</span>
									</a>
								</li>
								<li class="nav-item">
									<a href="/staff/lectureEvaluation/lectureEvalutaionForm.do">
										<span class="sub-item">강의평가</span>
									</a>
								</li>
								<li class="nav-item">
									<a href="/staff/lecturemanage/lecture/lectureList.do">
										<span class="sub-item">출석관리</span>
									</a>
								</li>
							</ul>
						</div>
					</li>
					
					<li class="nav-item">
						<a data-bs-toggle="collapse" href="#studentSupport" class="collapsed" aria-expanded="false">
							<i class="fas fa-hands-helping"></i>
							<p>학생지원</p>
							<span class="caret"></span>
						</a>
						<div class="collapse" id="studentSupport">
							<ul class="nav nav-collapse">
								<li class="nav-item">
									<a href="/staff/consult/consultScheduleList.do">
										<span class="sub-item">상담</span>
									</a>
								</li>
								<li class="nav-item">
									<a href="/staff/scholarship/staffScholarshipList.do">
										<span class="sub-item">장학</span>
									</a>
								</li>
								<li class="nav-item">
									<a href="/staff/applyGrd/graduateApply.do">
										<span class="sub-item">졸업신청</span>
									</a>
								</li>
								<li class="nav-item">
									<a href="/staff/requestCollection/requestCollection.do">
										<span class="sub-item">학적변경신청</span>
									</a>
								</li>
								<li class="nav-item">
									<a href="/staff/program/programList.do">
										<span class="sub-item">비교과</span>
									</a>
								</li>
							</ul>
						</div>
					</li>
					
					<li class="nav-item">
						<a data-bs-toggle="collapse" href="#academicAdmin" class="collapsed" aria-expanded="false">
							<i class="fas fa-file-signature"></i>
							<p>학사행정</p>
							<span class="caret"></span>
						</a>
						<div class="collapse" id="academicAdmin">
							<ul class="nav nav-collapse">
								<li class="nav-item">
									<a href="/staff/tuition/tuitionList.do">
										<span class="sub-item">등록금</span>
									</a>
								</li>
								<li class="nav-item">
									<a href="/staff/certification/certificationFormList.do">
										<span class="sub-item">증명서</span>
									</a>
								</li>
							</ul>
						</div>
					</li>
					
					<li class="nav-item">
						<a href="/staff/thesis/thesisList.do">
							<i class="fas fa-file-alt"></i>
							<p>논문관리</p>
						</a>
					</li>
						
					<li class="nav-item">
						<a href="/staff/facility/facilityList.do">
							<i class="fas fa-building"></i>
							<p>시설</p>
						</a>
					</li>
					
					<li class="nav-item">
						<a data-bs-toggle="collapse" href="#infoManagement" class="collapsed" aria-expanded="false">
							<i class="fas fa-info-circle"></i>
							<p>정보관리</p>
							<span class="caret"></span>
						</a>
						<div class="collapse" id="infoManagement">
							<ul class="nav nav-collapse">
								<li class="nav-item">
									<a href="/staff/notice/noticeList.do">
										<span class="sub-item">공지사항</span>
									</a>
								</li>
								<li class="nav-item">
									<a href="/staff/college/collegeList.do">
										<span class="sub-item">단과대학</span>
									</a>
								</li>
								<li class="nav-item">
									<a href="#">
										<span class="sub-item">통계</span>
									</a>
								</li>
							</ul>
						</div>
					</li>
					
					<li class="nav-item">
						<a href="/schedule.do">
							<i class="fas fa-calendar"></i>
							<p>캘린더</p>
						</a>
					</li>
					
					<!-- 알림 보내기는 ADMIN 권한만 -->
					<sec:authorize access="hasRole('STAFF')">
						<li class="nav-item">
							<a href="#" data-bs-toggle="modal" data-bs-target="#alarm">
								<i class="fas fa-bell"></i>
								<p>알림 보내기</p>
							</a>
						</li>
					</sec:authorize>
				</ul>
			</sec:authorize>

			<!-- Student Menu - 학생 권한을 가진 사용자만 보이게 -->
			<sec:authorize access="hasRole('STD')">
				<ul class="nav nav-secondary" id="studentMenu">
					<li class="nav-item">
						<a href="/student/lecture/enroll.do">
							<i class="fas fa-plus-circle"></i>
							<p>수강신청</p>
						</a>
					</li>
					<li class="nav-item">
						<a data-bs-toggle="collapse" href="#gradeManagement" class="collapsed" aria-expanded="false">
							<i class="fas fa-chart-line"></i>
							<p>성적관리</p>
							<span class="caret"></span>
						</a>
						<div class="collapse" id="gradeManagement">
							<ul class="nav nav-collapse">
								<li class="nav-item">
									<a href="/student/grade/history.do">
										<span class="sub-item">성적 조회</span>
									</a>
								</li>
								<li class="nav-item">
									<a href="/student/grade/appeal.do">
										<span class="sub-item">이의 신청</span>
									</a>
								</li>
							</ul>
						</div>
					</li>
					<li class="nav-item">
						<a href="/student/selectLecture.do">
							<i class="fas fa-star"></i>
							<p>강의평가</p>
						</a>
					</li>
					<li class="nav-item">
						<a data-bs-toggle="collapse" href="#studentState" class="collapsed" aria-expanded="false">
							<i class="fas fa-id-card"></i>
							<p>학적</p>
							<span class="caret"></span>
						</a>
						<div class="collapse" id="studentState">
							<ul class="nav nav-collapse">
								<li class="nav-item">
									<a href="/student/counsel/majorChangeList.do">
										<span class="sub-item">전공 변경</span>
									</a>
								</li>
								<li class="nav-item">
									<a href="/student/counsel/doubleMajorList.do">
										<span class="sub-item">복수 전공</span>
									</a>
								</li>
								<li class="nav-item">
									<a href="/student/counsel/leaveApplyList.do">
										<span class="sub-item">휴학</span>
									</a>
								</li>
								<li class="nav-item">
									<a href="/student/counsel/returnApplyList.do">
										<span class="sub-item">복학</span>
									</a>
								</li>
								<li class="nav-item">
									<a href="/student/counsel/graduationSuspensionList.do">
										<span class="sub-item">졸업 유예</span>
									</a>
								</li>
							</ul>
						</div>
					</li>
					<li class="nav-item">
						<a href="/student/tuition/tuitionPolicy">
							<i class="fas fa-user-plus"></i>
							<p>등록</p>
						</a>
					</li>
					<li class="nav-item">
						<a href="/student/scholarship/scholarshipBenefit.do">
							<i class="fas fa-graduation-cap"></i>
							<p>장학</p>
						</a>
					</li>
					<li class="nav-item">
						<a href="/student/certificate/issuedCertificateHistory.do">
							<i class="fas fa-certificate"></i>
							<p>증명서</p>
						</a>
					</li>
					<li class="nav-item">
						<a data-bs-toggle="collapse" href="#studentCounsel" class="collapsed" aria-expanded="false">
							<i class="fas fa-comments"></i>
							<p>상담</p>
							<span class="caret"></span>
						</a>
						<div class="collapse" id="studentCounsel">
							<ul class="nav nav-collapse">
								<li class="nav-item">
									<a href="/student/counsel/departmentCounsel/departmentCounsel.do">
										<span class="sub-item">학과 상담</span>
									</a>
								</li>
								<li class="nav-item">
									<a href="/student/counsel/employmentCounsel/employmentCounsel.do">
										<span class="sub-item">취업 상담</span>
									</a>
								</li>
							</ul>
						</div>
					</li>
					<li class="nav-item">
						<a href="#">
							<i class="fas fa-handshake"></i>
							<p>취업·멘토링</p>
						</a>
					</li>
					<li class="nav-item">
						<a data-bs-toggle="collapse" href="#studentProgram" class="collapsed" aria-expanded="false">
							<i class="fas fa-puzzle-piece"></i>
							<p>비교과</p>
							<span class="caret"></span>
						</a>
						<div class="collapse" id="studentProgram">
							<ul class="nav nav-collapse">
								<li class="nav-item">
									<a href="/student/program/programApplList.do">
										<span class="sub-item">비교과 신청</span>
									</a>
								</li>
								<li class="nav-item">
									<a href="/student/program/myParticipationList.do">
										<span class="sub-item">내 비교과 프로그램</span>
									</a>
								</li>
							</ul>
						</div>
					</li>
					<li class="nav-item">
						<a href="/student/facility/studentFacilityList.do">
							<i class="fas fa-building"></i>
							<p>시설예약</p>
						</a>
					</li>
					<li class="nav-item">
						<a href="/student/notice/noticeList.do">
							<i class="fas fa-bullhorn"></i>
							<p>공지사항</p>
						</a>
					</li>
					<li class="nav-item">
						<a href="http://localhost:6060/eclass/lecture/<sec:authentication property="principal.username"/>">
							<i class="fas fa-laptop"></i>
							<p>사이버 강의실</p>
						</a>
					</li>
					<li class="nav-item">
						<a href="/schedule.do">
							<i class="fas fa-calendar"></i>
							<p>캘린더</p>
						</a>
					</li>
				</ul>
			</sec:authorize>

			<!-- Professor Menu - 교수 권한을 가진 사용자만 보이게 -->
			<sec:authorize access="hasRole('PROF')">
				<ul class="nav nav-secondary" id="professorMenu">
					<li class="nav-item">
						<a href="/professor/lecture/lectureList.do">
							<i class="fas fa-book-open"></i>
							<p>강의 개설신청</p>
						</a>
					</li>
					<li class="nav-item">
						<a href="/professor/attendclass/attendclassList.do">
							<i class="fas fa-chalkboard"></i>
							<p>강의관리</p>
						</a>
					</li>
					<li class="nav-item">
						<a href="/professor/exam/examList.do">
							<i class="fas fa-pencil-alt"></i>
							<p>시험관리</p>
						</a>
					</li>
					<li class="nav-item">
						<a href="http://localhost:6060/eclass">
							<i class="fas fa-folder-open"></i>
							<p>과제관리</p>
						</a>
					</li>
					<li class="nav-item">
						<a href="/professor/attendance/attendclassList.do">
							<i class="fas fa-clipboard-check"></i>
							<p>출석관리</p>
						</a>
					</li>
					<li class="nav-item">
						<a href="/professor/grade/attendclassList.do">
							<i class="fas fa-chart-line"></i>
							<p>성적관리</p>
						</a>
					</li>
					<li class="nav-item">
						<a href="/professor/evaluation/attendclassList.do">
							<i class="fas fa-star"></i>
							<p>강의평가</p>
						</a>
					</li>
					<li class="nav-item">
						<a href="/professor/thesis/thesisList.do">
							<i class="fas fa-file-alt"></i>
							<p>논문관리</p>
						</a>
					</li>
					<li class="nav-item">
						<a href="/schedule.do">
							<i class="fas fa-calendar"></i>
							<p>캘린더</p>
						</a>
					</li>
					<li class="nav-item">
						<a href="/professor/dataManagement/data.do">
							<i class="fas fa-database"></i>
							<p>데이터관리</p>
						</a>
					</li>
					<li class="nav-item">
						<a href="/staff/program/programList.do">
							<i class="fas fa-puzzle-piece"></i>
							<p>비교과관리</p>
						</a>
					</li>
					<li class="nav-item">
						<a href="http://localhost:6060/eclass/lecture/<sec:authentication property="principal.username"/>"> 
							<i class="fas fa-laptop"></i>
							<p>사이버 강의실</p>
						</a>
					</li>
				</ul>
			</sec:authorize>
		</div>
	</div>
</div>

<!-- 알림 모달 - ADMIN 권한만 보이게 -->
<sec:authorize access="hasRole('ADMIN')">
	<div class="modal fade" id="alarm" tabindex="-1" aria-hidden="true">
		<div class="modal-dialog modal-dialog-scrollable">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title">알림 전송</h5>
				</div>
				
				<div class="modal-body">
					<label>보낼 대상</label>
					<div class="d-flex gap-3 mb-3">
						<div class="form-check form-check-inline">
							<input class="form-check-input" type="checkbox" id="targetStudent" name="targetRole" value="student">
							<label class="form-check-label" for="targetStudent">학생</label>
						</div>
						<div class="form-check form-check-inline">
							<input class="form-check-input" type="checkbox" id="targetProfessor" name="targetRole" value="professor">
							<label class="form-check-label" for="targetProfessor">교수</label>
						</div>
						<div class="form-check form-check-inline">
							<input class="form-check-input" type="checkbox" id="targetStaff" name="targetRole" value="staff">
							<label class="form-check-label" for="targetStaff">교직원</label>
						</div>
					</div>
					<label>내용</label>
					<textarea id="notificationMessage" class="textareaField" rows="15" cols="" style="resize: none;"></textarea>
				</div>
				
				<div class="modal-footer">
					<button type="button" class="btn submitButton" id="sendBtn">전송</button>
					<button type="button" class="btn deleteButton" data-bs-dismiss="modal">닫기</button>
				</div>
			</div>
		</div>
	</div>
</sec:authorize>

<script>
document.addEventListener('DOMContentLoaded', function () {
	// 역할 기반으로 메뉴를 자동으로 결정
	const staffMenu = document.getElementById('staffMenu');
	const studentMenu = document.getElementById('studentMenu');
	const professorMenu = document.getElementById('professorMenu');
	const roleSelector = document.getElementById('roleSelector');

	// 현재 활성화된 메뉴 확인
	let currentRole = null;
	if (staffMenu) currentRole = 'staff';
	else if (studentMenu) currentRole = 'student';
	else if (professorMenu) currentRole = 'professor';

	// Role Selector가 있는 경우 (ADMIN 권한)
	if (roleSelector && currentRole) {
		const menus = {
			staff: staffMenu,
			student: studentMenu,
			professor: professorMenu
		};

		function closeAllCollapses() {
			document.querySelectorAll('.collapse.show').forEach(el => el.classList.remove('show'));
			document.querySelectorAll('[data-bs-toggle="collapse"]').forEach(el => {
				el.classList.add('collapsed');
				el.setAttribute('aria-expanded', 'false');
			});
		}

		function deactivateAllMenuItems() {
			document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
		}

		function showOnlyMenu(role) {
			// hide all
			Object.values(menus).forEach(menu => {
				if (menu) menu.style.display = 'none';
			});

			// show selected
			const currentMenu = menus[role];
			if (currentMenu) {
				currentMenu.style.display = 'block';
				// optional: set first item active
				const firstItem = currentMenu.querySelector('.nav-item:not(.collapse):not(.nav-collapse)');
				if (firstItem) firstItem.classList.add('active');
			}
		}

		// 초기 설정
		const savedRole = localStorage.getItem('selectedRole') || currentRole;
		roleSelector.value = savedRole;
		showOnlyMenu(savedRole);
		closeAllCollapses();
		deactivateAllMenuItems();

		// 역할 변경 이벤트
		roleSelector.addEventListener('change', function () {
			const selectedRole = this.value;
			localStorage.setItem('selectedRole', selectedRole);
			showOnlyMenu(selectedRole);
			closeAllCollapses();
			deactivateAllMenuItems();
		});
	}

	// 메뉴 클릭 시 active 처리
	document.addEventListener('click', function (e) {
		const navLink = e.target.closest('.nav-item > a[href]:not([data-bs-toggle="collapse"])');
		if (navLink) {
			document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
			const navItem = navLink.closest('.nav-item');
			if (navItem) navItem.classList.add('active');
		}
	});
	
	// 알림 보내기 (ADMIN 권한이 있는 경우에만)
	const sendBtn = document.querySelector('#sendBtn');
	if (sendBtn) {
		sendBtn.addEventListener('click', function() {
			const message = document.getElementById('notificationMessage').value.trim();
			const checkedRoles = Array.from(document.querySelectorAll('input[name="targetRole"]:checked')).map(cb => cb.value);
			
			if (checkedRoles.length === 0) {
				alert('보낼 대상을 선택하세요.');
				return;
			}
			
			if (!message) {
				alert('메시지를 입력하세요.');
				return;
			}
			
			fetch('/sendNotification.do', {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json'
				},
				body: JSON.stringify({
					roles: checkedRoles,
					message: message,
					linkUrl: '#'
				})
			}).then(resp => {
				if (resp.ok) {
					return resp.text();
				} else {
					throw new Error('서버 에러');
				}
			}).then(result => {
				alert('알림 전송되었습니다.');
				const alarmModal = bootstrap.Modal.getInstance(document.getElementById('alarm'));
				alarmModal.hide();
				document.getElementById('notificationMessage').value = '';
				document.querySelectorAll('input[name="targetRole"]:checked').forEach(cb => cb.checked = false);
			}).catch(err => {
				alert('알림 전송 실패: ' + err.message);
			});
		});
	}
});
</script>