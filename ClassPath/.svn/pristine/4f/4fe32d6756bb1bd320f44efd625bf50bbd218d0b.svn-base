package kr.or.ddit.pfcp.professor.exam.controller;

import java.io.IOException;
import java.security.Principal;
import java.time.LocalDate;
import java.time.format.DateTimeFormatter;
import java.util.List;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.util.MultiValueMap;
import org.springframework.validation.BindingResult;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.ModelAttribute;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.multipart.MultipartFile;
import org.springframework.web.servlet.mvc.support.RedirectAttributes;

import kr.or.ddit.pfcp.common.service.AtchFileService;
import kr.or.ddit.pfcp.common.service.FileRefService;
import kr.or.ddit.pfcp.common.vo.AtchFileVO;
import kr.or.ddit.pfcp.common.vo.ExamVO;
import kr.or.ddit.pfcp.common.vo.FileRefVO;
import kr.or.ddit.pfcp.professor.exam.service.ProfessorExamService;
import kr.or.ddit.validate.utils.ErrorsUtils;

/**
*
* @author 김태수
* @since 2025.07.01
* @see
﻿ * << 개정이력(Modification Information) >>
* 수정일	 |		수정자		|	수정 내용
* -----------|------------------|--------------------------
* 2025.07.01 | 		김태수   	|   최초 작성
* 2025.07.15 |		서경덕		|	내용 추가
* 
*/
@Controller
@RequestMapping("/professor/exam")
public class ProfessorExamController {
	@Autowired
	private ProfessorExamService professorExamService;
	
	@Autowired
	private FileRefService fileRefService;
	
	@Autowired
	private AtchFileService atchFileService;
	
	@Autowired
	private ErrorsUtils errorsUtils;
	
	static final String MODEL_NAME = "exam";
	
	@ModelAttribute(MODEL_NAME)
	public ExamVO exam() {
		return new ExamVO();
	}
	
	/**
	 * 시험 정보 조회 - 시험 유형 , 시험 제목 , 교과목
	 * @return
	 */
	@GetMapping("examList.do")
	public String examList(
		Principal principal,
		Model model
	) {
		String professorNo = principal.getName();
		
		List<ExamVO> examList = professorExamService.readExamList(professorNo);
		
		int count = examList.size();
		
		model.addAttribute("examList", examList);
		model.addAttribute("count", count);
		
		return "pfcp/professor/exam/examList";
	}
	
	
	/**
	 * 시험 등록
	 * @return
	 */
	@GetMapping("examInsert.do")
	public String examInsert() {
		return "pfcp/professor/exam/examInsert";
	}
	
	@PostMapping("examInsertProcess.do")
	public String examInsertFormProcess(
		@RequestParam("answerList") List<String> answerList,
		@ModelAttribute(MODEL_NAME) ExamVO exam,
		BindingResult errors,
		RedirectAttributes redirectAttributes
	) throws IOException {
		String lvn;
		
		if(!errors.hasErrors()) {
			MultipartFile file = exam.getUploadFile();
			
			if (file != null && !file.isEmpty()) {
				// ID 생성
	            String atchId = "ATCH" + System.currentTimeMillis();
	            String fileRefNo = "FR" + System.currentTimeMillis();
	            
	            byte[] fileBytes = file.getBytes();

	            // ATCH_FILE insert
	            AtchFileVO atchFile = new AtchFileVO();
	            atchFile.setAtchId(atchId);
	            atchFile.setAtchMime(file.getContentType());
	            atchFile.setAtchOriginName(file.getOriginalFilename());
	            atchFile.setAtchSaveName(atchId + "_" + file.getOriginalFilename());
	            atchFile.setAtchSize(file.getSize());
	            atchFile.setAtchDate(LocalDate.now().format(DateTimeFormatter.BASIC_ISO_DATE));
	            atchFile.setAtchContent(fileBytes);
	            
	            atchFileService.createAtchFile(atchFile);
	            
	            // FILE_REF insert
	            FileRefVO fileRef = new FileRefVO();
	            fileRef.setFileRefNo(fileRefNo);
	            fileRef.setFileRefType("SCHOLARSHIP_APPLY");
	            fileRef.setFileRefTargetId(exam.getExamNo());
	            fileRef.setAtchId(atchId);
	            
	            fileRefService.createFileRef(fileRef);
	            
	            exam.setFileRefNo(fileRefNo);
			}
			
			professorExamService.createExam(exam);
			
			lvn = "redirect:/professor/exam/examList.do";
		} else {
			redirectAttributes.addFlashAttribute(MODEL_NAME, exam);
			
			MultiValueMap<String, String> customErrors = errorsUtils.errorsToMap(errors);
			redirectAttributes.addFlashAttribute("errors", customErrors);
			
			lvn = "redirect:/staff/professorManagement/professorInsert.do";
		}
		
		return lvn;
	}
	
	/**
	 * 시험 수정
	 * @return
	 */
	@GetMapping("examUpdate.do")
	public String examUpdate() {
		return "pfcp/professor/exam/examUpdate";
	}
	
	/**
	 * 시험 상세 조회
	 * @return
	 */
	@GetMapping("examDetail.do")
	public String examDetail() {
		return "pfcp/professor/exam/examDetail";
	}
	
	/**
	 * 시험 삭제
	 * @return
	 */
	@GetMapping("examDelete.do")
	public String examDelete() {
		return "redirect:/professor/exam/examList.do";
	}
	
	
	
	///////////////////////
	
	/**
	 * 문제 관리 - 문제 조회
	 * @return
	 */
	@GetMapping("questionList.do")
	public String questionList() {
		return "pfcp/professor/exam/questionList";
	}
	
	/**
	 * 문제 등록
	 * @return
	 */
	@GetMapping("questionInsert.do")
	public String questionInsert() {
		return "pfcp/professor/exam/questionInsert";
	}
	
	/**
	 * 문제 수정
	 * @return
	 */
	@GetMapping("questionUpdate.do")
	public String questionUpdate() {
		return "pfcp/professor/exam/questionUpdate";
	}
	
	/**
	 * 문제 상세 조회
	 * @return
	 */
	@GetMapping("questionDetail.do")
	public String questionDetail() {
		return "pfcp/professor/exam/questionDetail";
	}
	
	/**
	 * 문제 삭제
	 * @return
	 */
	@GetMapping("questionDelete.do")
	public String questionDelete() {
		return "redirect:/professor/exam/questionList.do";
	}
	
	
}
