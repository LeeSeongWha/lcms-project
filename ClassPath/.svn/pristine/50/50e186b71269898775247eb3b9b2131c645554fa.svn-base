<%@ page contentType="text/html;charset=UTF-8" language="java"%>
<%@ taglib uri="jakarta.tags.core" prefix="c"%>
<%@ taglib uri="http://www.springframework.org/tags/form" prefix="form"%>
<!DOCTYPE html>
<html>
<head>
<title>ì¼ì • ê´€ë¦¬</title>

<link rel="stylesheet" href="/dist/assets/css/bodyFormat.css">
<link
	href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.5/main.min.css"
	rel="stylesheet" />
<script
	src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.5/main.min.js"></script>
<script
	src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.5/locales-all.min.js"></script>

<style>
#calendar {
	max-width: 900px;
	margin: 50px auto;
}

.error {
	color: red;
	font-size: 0.9em;
}
</style>
</head>
<body>
	<h2 style="text-align: center;">êµì§ì› ì¼ì • ê´€ë¦¬</h2>
	<div id="calendar"></div>

	<script>
    document.addEventListener('DOMContentLoaded', function () {
      var calendarEl = document.getElementById('calendar');
      var calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        locale: 'ko',
        headerToolbar: {
          left: 'prev,next today',
          center: 'title',
          right: 'dayGridMonth'
        },
        events: '/staff/schedule/list',
        

        eventClick: function (info) {
          const data = info.event.extendedProps;
          let details = "";
          details += "ğŸ“Œ ì œëª©: " + info.event.title + "\n";
          details += "ğŸ“… ì‹œì‘ì¼: " + data.startDate + "\n";
          details += "ğŸ“… ì¢…ë£Œì¼: " + data.endDate + "\n";
          details += "ğŸ“ ì„¤ëª…: " + (data.scheduleDesp || 'ì—†ìŒ') + "\n";
          alert(details);
        },

        eventDidMount: function(info) {
          // ğŸŸ¢ ì¼ì • ë§ˆì§€ë§‰ ì¡°ê°ì—ë§Œ ë²„íŠ¼ í‘œì‹œ
          if (!info.isEnd) return;

          const scheduleNo = info.event.id; 

          const titleEl = info.el.querySelector('.fc-event-title');
          if (!titleEl) return;

          // ë²„íŠ¼ ì˜ì—­ ìƒì„±
          const btnWrap = document.createElement('span');
          btnWrap.style.marginLeft = 'auto';
          btnWrap.style.display = 'flex';
          btnWrap.style.gap = '4px';

          // âœï¸ ìˆ˜ì • ë²„íŠ¼
          const editBtn = document.createElement('span');
         
          editBtn.innerHTML = 'âœï¸';
          editBtn.title = 'ìˆ˜ì •';
          editBtn.style.cursor = 'pointer';
          editBtn.style.fontSize = '14px';
          editBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            console.log("pathvaribleë¡œ ë„˜ê²¨ë°›ì„ no : =>>>", info.event.id);
            fetch(`/staff/schedule/\${scheduleNo}`)
              .then(res => res.json())
              .then(data => {
                document.querySelector("#scheduleNo").value = data.scheduleNo;
                document.querySelector("#scheduleTitle").value = data.scheduleTitle;
                document.querySelector("#startDate").value = data.startDate;
                document.querySelector("#endDate").value = data.endDate;
                document.querySelector("#scheduleType").value = data.scheduleType;
                document.querySelector("#scheduleDesp").value = data.scheduleDesp;
                document.querySelector("#refTypeSelect").value = data.refType;
                document.querySelector("#formMode").value = "update";
                document.querySelector("#submitBtn").textContent = "ìˆ˜ì •";
                document.querySelector("#resetBtn").style.display = "inline-block";
              });
          });

          // ğŸ—‘ï¸ ì‚­ì œ ë²„íŠ¼
          const deleteBtn = document.createElement('span');
          deleteBtn.innerHTML = 'ğŸ—‘ï¸';
          deleteBtn.title = 'ì‚­ì œ';
          deleteBtn.style.cursor = 'pointer';
          deleteBtn.style.fontSize = '14px';
          deleteBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            if (confirm("ì´ ì¼ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
              fetch(`/staff/schedule/\${scheduleNo}`, {
                method: 'DELETE'
              })
              .then(res => res.text())
              .then(result => {
                if (result === 'success') {
                  alert("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                  info.event.remove();
                } else {
                  alert("ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                }
              });
            }
          });

          // ë²„íŠ¼ ì‚½ì…
          btnWrap.appendChild(editBtn);
          btnWrap.appendChild(deleteBtn);
          titleEl.style.display = 'flex';
          titleEl.style.alignItems = 'center';
          titleEl.appendChild(btnWrap);
        }
      });

      // ë“±ë¡/ìˆ˜ì • ì´ˆê¸°í™”
      document.querySelector("#resetBtn").addEventListener("click", function () {
        document.querySelector("#scheduleNo").value = "";
        document.querySelector("#scheduleTitle").value = "";
        document.querySelector("#startDate").value = "";
        document.querySelector("#endDate").value = "";
        document.querySelector("#scheduleType").value = "";
        document.querySelector("#scheduleDesp").value = "";
        document.querySelector("#refTypeSelect").selectedIndex = 0;
        document.querySelector("#formMode").value = "insert";
        document.querySelector("#submitBtn").textContent = "ì €ì¥";
        document.querySelector("#resetBtn").style.display = "none";
      });

      calendar.render();
    });
  </script>

	<!-- ì¼ì • ë“±ë¡/ìˆ˜ì • í¼ -->
	<h3 style="text-align: center;">ğŸ“¥ ì¼ì • ë“±ë¡ / ìˆ˜ì •</h3>
	<button class="btn btn-secondary" type="button" id="resetBtn"
		style="display: none;">ë“±ë¡ìœ¼ë¡œ</button>

	<form:form modelAttribute="scheduleVO" action="/staff/schedule/save"
		method="post" style="width:900px; margin: 0 auto;">
		<form:hidden path="scheduleNo" id="scheduleNo" />
		<input type="hidden" name="formMode" id="formMode" value="insert" />
		<fieldset style="padding: 20px; border: 1px solid #ccc;">
			<table style="width: 100%; border-collapse: collapse;">
				<tr>
					<td><label for="scheduleTitle">ì¼ì • ì œëª©</label></td>
					<td><form:input path="scheduleTitle" id="scheduleTitle" /> <form:errors
							path="scheduleTitle" cssClass="error" /></td>
				</tr>
				<tr>
					<td><label for="startDate">ì‹œì‘ì¼</label></td>
					<td><form:input path="startDate" id="startDate" type="date" />
						<form:errors path="startDate" cssClass="error" /></td>
				</tr>
				<tr>
					<td><label for="endDate">ì¢…ë£Œì¼</label></td>
					<td><form:input path="endDate" id="endDate" type="date" /> <form:errors
							path="endDate" cssClass="error" /></td>
				</tr>
				<tr>
					<td><label for="scheduleType">ì¼ì • ìœ í˜•</label></td>
					<td><form:input path="scheduleType" id="scheduleType" /> <form:errors
							path="scheduleType" cssClass="error" /></td>
				</tr>
				<tr>
					<td><label for="refTypeSelect">ì°¸ì¡° ìœ í˜•</label></td>
					<td><form:select path="ref.refType" id="refTypeSelect"
							items="${refTypeList}" itemValue="refType" itemLabel="refType" />
						<form:errors path="ref.refType" cssClass="error" /></td>
				</tr>
				<tr>
					<td><label for="scheduleDesp">ì¼ì • ì„¤ëª…</label></td>
					<td><form:textarea path="scheduleDesp" id="scheduleDesp"
							rows="3" cols="40" /> <form:errors path="scheduleDesp"
							cssClass="error" /></td>
				</tr>
			</table>
			<div style="text-align: right; margin-top: 15px;">
				<button class="btn btn-primary" type="submit" id="submitBtn">ì €ì¥</button>
			</div>
		</fieldset>
	</form:form>

</body>
</html>
