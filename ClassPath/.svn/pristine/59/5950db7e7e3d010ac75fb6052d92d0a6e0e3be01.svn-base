<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper
	namespace="kr.or.ddit.pfcp.staff.program.mapper.StaffProgramMapper">
	<resultMap id="programMap"
		type="kr.or.ddit.pfcp.common.vo.ProgramVO">
		<id property="programNo" column="PROGRAM_NO" />
		<result property="userNo" column="USER_NO" />
		<result property="typeCode" column="TYPE_CODE" />
		<result property="programTitle" column="PROGRAM_TITLE" />
		<result property="programDesp" column="PROGRAM_DESP" />
		<result property="programCapacity" column="PROGRAM_CAPACITY" />
		<result property="startDate" column="START_DATE" />
		<result property="endDate" column="END_DATE" />
		<result property="place" column="PLACE" />
		<result property="programActive" column="PROGRAM_ACTIVE" />

		<!-- TypeVO 조인 정보 매핑 -->
		<association property="type"
			javaType="kr.or.ddit.pfcp.common.vo.TypeVO">
			<result property="typeCode" column="TYPE_CODE" />
			<result property="typeName" column="TYPE_NAME" />
			<result property="typeGroup" column="TYPE_GROUP" />
			<result property="isActive" column="IS_ACTIVE" />
		</association>
	</resultMap>

	<resultMap id="programWithEnrollMap"
		type="kr.or.ddit.pfcp.common.vo.ProgramVO">
		<id property="programNo" column="PROGRAM_NO" />
		<result property="typeCode" column="TYPE_CODE" />
		<result property="programTitle" column="PROGRAM_TITLE" />
		<result property="programDesp" column="PROGRAM_DESP" />
		<result property="programCapacity" column="PROGRAM_CAPACITY" />
		<result property="startDate" column="START_DATE" />
		<result property="endDate" column="END_DATE" />
		<result property="place" column="PLACE" />
		<result property="programActive" column="PROGRAM_ACTIVE" />
		<result property="userNo" column="USER_NO" />

		<!-- 신청자 목록 -->
		<collection property="enrollList"
			ofType="kr.or.ddit.pfcp.common.vo.ProgramEnrollVO">
			<id property="enrollNo" column="ENROLL_NO" />
			<result property="programNo" column="PROGRAM_NO" />
			<result property="userNo" column="ENROLL_USER_NO" />
			<result property="applyDate" column="APPLY_DATE" />
			<result property="isAttended" column="IS_ATTENDED" />
			<result property="isCompleted" column="IS_COMPLETED" />
			<result property="programScore" column="PROGRAM_SCORE" />
			<result property="volunteerHour" column="VOLUNTEER_HOUR" />
			<result property="isCertIssued" column="IS_CERT_ISSUED" />

			<!-- 중첩 association: STUDENT → USER -->
			<association property="student"
				javaType="kr.or.ddit.pfcp.common.vo.StudentVO">
				<result property="userNo" column="ENROLL_USER_NO" />
				<result property="userName" column="USER_NAME" />
				<result property="departmentNo" column="DEPARTMENT_NO" />
			</association>
		</collection>
	</resultMap>

	<resultMap id="enrollWithCertReqMap"
		type="kr.or.ddit.pfcp.common.vo.ProgramEnrollVO">
		<id property="enrollNo" column="ENROLL_NO" />
		<result property="userNo" column="USER_NO" />
		<result property="applyDate" column="APPLY_DATE" />
		<result property="isCompleted" column="IS_COMPLETED" />
		<result property="isAttended" column="IS_ATTENDED" />
		<result property="isCertIssued" column="IS_CERT_ISSUED" />

		<!-- 조인된 프로그램 정보 -->
		<association property="program"
			javaType="kr.or.ddit.pfcp.common.vo.ProgramVO">
			<result property="programNo" column="PROGRAM_NO" />
			<result property="programTitle" column="PROGRAM_TITLE" />
			<result property="startDate" column="START_DATE" />
			<result property="endDate" column="END_DATE" />
		</association>

		<!-- 조인된 학생(이름 등) -->
		<association property="student"
			javaType="kr.or.ddit.pfcp.common.vo.StudentVO">
			<result property="userName" column="USER_NAME" />
		</association>

		<!-- 발급 요청 정보 -->
		<association property="programcert"
			javaType="kr.or.ddit.pfcp.common.vo.ProgramCertReqVO">
			<result property="certReqno" column="CERT_REQNO" />
			<result property="cerreqDate" column="CERREQ_DATE" />
			<result property="cerreqStatus" column="CERREQ_STATUS" />
			<result property="cerreqComment" column="CERREQ_COMMENT" />
		</association>
	</resultMap>
	<resultMap id="IssueWithFileMap" type="kr.or.ddit.pfcp.common.vo.ProgramCertIssueVO">
		<result property="certIssueno" column="CERT_ISSUENO" />
		<result property="certReqno" column="CERT_REQNO" />
		<result property="issueDate" column="ISSUE_DATE" />
		<result property="fileRefNo" column="FILE_REF_NO" />
		<result property="userNo" column="USER_NO" />

		<result property="atchOriginName" column="ATCH_ORIGIN_NAME" />
		<result property="atchSaveName" column="ATCH_SAVE_NAME" />
		<result property="atchMime" column="ATCH_MIME" />
		<result property="atchContent" column="ATCH_CONTENT" />
		<result property="atchSize" column="ATCH_SIZE" />
		<result property="atchDate" column="ATCH_DATE" />
	</resultMap>

	<resultMap id="programFeedbackMap"
		type="kr.or.ddit.pfcp.common.vo.ProgramFeedbackVO">
		<id property="feedbackNo" column="FEEDBACK_NO" />
		<result property="feedbackAccount" column="FEEDBACK_ACCOUNT" />
		<result property="feedbackComment" column="FEEDBACK_COMMENT" />
		<result property="submitDate" column="SUBMIT_DATE" />
		<result property="enrollNo" column="ENROLL_NO" />
		<result property="criteriaNo" column="CRITERIA_NO" />
		<result property="programNo" column="PROGRAM_NO" />

		<!-- program JOIN 결과 매핑 -->
		<association property="program"
			javaType="kr.or.ddit.pfcp.common.vo.ProgramVO">
			<result property="programNo" column="PROGRAM_NO" />
			<result property="programTitle" column="PROGRAM_TITLE" />
			<result property="typeCode" column="TYPE_CODE" />
			<!-- 필요하면 capacity, active 등 추가 -->
		</association>

		<!-- enroll JOIN 결과 매핑 -->
		<association property="programEnroll"
			javaType="kr.or.ddit.pfcp.common.vo.ProgramEnrollVO">
			<result property="enrollNo" column="ENROLL_NO" />
			<result property="userNo" column="USER_NO" />
			<!-- 추가 필드 있으면 여기도 확장 -->
		</association>
		
		<association property="user"
			javaType="kr.or.ddit.pfcp.common.vo.UserVO">
			<id property="userNo" column="USER_NO" />
			<result property="userName" column="USER_NAME" />
		</association>
	</resultMap>
	


	<!--프로그램 목록 조회 -->
	<select id="selectProgramList"
		resultType="kr.or.ddit.pfcp.common.vo.ProgramVO"
		resultMap="programMap">
		SELECT
		P.PROGRAM_NO
		, P.TYPE_CODE
		, P.PROGRAM_TITLE
		, P.PROGRAM_DESP
		, P.PROGRAM_CAPACITY
		, P.START_DATE
		, P.END_DATE
		, P.PLACE
		, P.PROGRAM_ACTIVE
		, P.USER_NO
		, T.TYPE_CODE
		, T.TYPE_NAME
		, T.TYPE_GROUP
		, T.IS_ACTIVE
		FROM PROGRAM P
		LEFT JOIN TYPE T ON P.TYPE_CODE =
		T.TYPE_CODE
		WHERE T.TYPE_GROUP = 'PROGRAM' AND P.PROGRAM_ACTIVE != 'D'
		ORDER BY P.START_DATE DESC
	</select>

	<!--모집중인 프로그램만 조회 -->
	<select id="selectOpenProgramList"
		resultType="kr.or.ddit.pfcp.common.vo.ProgramVO"
		resultMap="programMap">
		SELECT
		P.PROGRAM_NO
		, P.TYPE_CODE
		, P.PROGRAM_TITLE
		, P.PROGRAM_DESP
		, P.PROGRAM_CAPACITY
		, P.START_DATE
		, P.END_DATE
		, P.PLACE
		, P.PROGRAM_ACTIVE
		, P.USER_NO
		, T.TYPE_CODE
		, T.TYPE_NAME
		, T.TYPE_GROUP
		, T.IS_ACTIVE
		FROM PROGRAM P
		LEFT JOIN TYPE T ON P.TYPE_CODE =
		T.TYPE_CODE
		WHERE T.TYPE_GROUP = 'PROGRAM' AND P.PROGRAM_ACTIVE = 'N'
		ORDER BY P.START_DATE DESC
	</select>

	<!--프로그램 단건 상세 조회 -->
	<select id="selectProgramById" parameterType="string"
		resultMap="programMap">
		SELECT
		P.PROGRAM_NO,
		P.TYPE_CODE,
		P.PROGRAM_TITLE,
		P.PROGRAM_DESP,
		P.PROGRAM_CAPACITY,
		P.START_DATE,
		P.END_DATE,
		P.PLACE,
		P.PROGRAM_ACTIVE,
		P.USER_NO,
		T.TYPE_CODE,
		T.TYPE_NAME,
		T.TYPE_GROUP,
		T.IS_ACTIVE

		FROM PROGRAM P
		LEFT JOIN TYPE T ON P.TYPE_CODE = T.TYPE_CODE
		WHERE P.PROGRAM_NO = #{programNo}
	</select>

	<!-- 비교과 프로그램 타입조회 -->
	<select id="selectProgramType"
		resultType="kr.or.ddit.pfcp.common.vo.TypeVO">
		SELECT
		TYPE_CODE
		, TYPE_NAME
		, IS_ACTIVE
		, TYPE_GROUP
		FROM TYPE
		WHERE TYPE_GROUP='PROGRAM'
	</select>

	<insert id="insertProgram"
		parameterType="kr.or.ddit.pfcp.common.vo.ProgramVO">
		<selectKey resultType="string" keyProperty="programNo"
			order="BEFORE">
			SELECT 'PRG_' || LPAD(PROGRAM_SEQ.NEXTVAL, 5, '0')
			FROM DUAL
		</selectKey>

		INSERT INTO PROGRAM (
		PROGRAM_NO
		, TYPE_CODE
		, PROGRAM_TITLE
		, PROGRAM_DESP
		, PROGRAM_CAPACITY
		, START_DATE
		, END_DATE
		, PLACE
		, PROGRAM_ACTIVE
		, USER_NO
		) VALUES (
		#{programNo}
		, #{typeCode}
		,
		#{programTitle}
		, #{programDesp}
		, #{programCapacity}
		, #{startDate}
		, #{endDate}
		, #{place}
		, #{programActive}
		, #{userNo}
		)
	</insert>
	<!-- 수정 -->
	<update id="updateProgram"
		parameterType="kr.or.ddit.pfcp.common.vo.ProgramVO">
		UPDATE PROGRAM SET
		TYPE_CODE = #{typeCode},
		PROGRAM_TITLE
		= #{programTitle},
		PROGRAM_DESP = #{programDesp},
		PROGRAM_CAPACITY =
		#{programCapacity},
		START_DATE = #{startDate},
		END_DATE = #{endDate},
		PLACE = #{place},
		PROGRAM_ACTIVE = #{programActive}
		WHERE PROGRAM_NO =
		#{programNo}
	</update>

	<!--비교과 신청 목록 조회 -->
	<select id="selectEnrollListByProgramNo"
		resultType="kr.or.ddit.pfcp.common.vo.ProgramEnrollVO">
		SELECT E.ENROLL_NO
		, E.PROGRAM_NO
		, E.USER_NO
		, E.APPLY_DATE
		, E.IS_ATTENDED
		, E.IS_COMPLETED
		, E.PROGRAM_SCORE
		, E.VOLUNTEER_HOUR
		, E.IS_CERT_ISSUED
		, S.USER_NO
		FROM PROGRAM_ENROLL E
		JOIN STUDENT S ON
		E.USER_NO = S.USER_NO
		WHERE E.PROGRAM_NO = #{programNo}
	</select>

	<update id="deleteProgram">
		UPDATE PROGRAM
		SET PROGRAM_ACTIVE = 'D'
		WHERE
		PROGRAM_NO = #{programNo}
	</update>

	<select id="selectProgramWithEnroll"
		resultMap="programWithEnrollMap">
		SELECT
		P.PROGRAM_NO, P.TYPE_CODE, P.PROGRAM_TITLE,
		P.PROGRAM_DESP,
		P.PROGRAM_CAPACITY, P.START_DATE, P.END_DATE, P.PLACE,
		P.PROGRAM_ACTIVE, P.USER_NO,

		E.ENROLL_NO, E.USER_NO AS ENROLL_USER_NO,
		E.APPLY_DATE,
		E.IS_ATTENDED, E.IS_COMPLETED, E.PROGRAM_SCORE,
		E.VOLUNTEER_HOUR, E.IS_CERT_ISSUED, S.DEPARTMENT_NO,
		U.USER_NAME

		FROM
		PROGRAM P
		LEFT JOIN PROGRAM_ENROLL E ON P.PROGRAM_NO = E.PROGRAM_NO
		LEFT JOIN STUDENT S ON E.USER_NO = S.USER_NO
		LEFT JOIN TB_USER U ON
		S.USER_NO = U.USER_NO

		WHERE P.PROGRAM_NO = #{programNo}

	</select>

	<update id="updateAttended"
		parameterType="kr.or.ddit.pfcp.common.vo.ProgramEnrollVO">
		UPDATE PROGRAM_ENROLL
		SET IS_ATTENDED = #{isAttended}
		WHERE ENROLL_NO = #{enrollNo}
	</update>

	<update id="updateCompletion"
		parameterType="kr.or.ddit.pfcp.common.vo.ProgramEnrollVO">
		UPDATE PROGRAM_ENROLL
		SET IS_COMPLETED = #{isCompleted}
		WHERE ENROLL_NO = #{enrollNo}
	</update>

	<update id="updateIsCertIssued" parameterType="string">
		UPDATE
		PROGRAM_ENROLL
		SET IS_CERT_ISSUED = 'Y'
		WHERE ENROLL_NO = #{enrollNo}
	</update>


	<update id="updateCertReqStatus" parameterType="map">
		UPDATE
		PROGRAM_CERT_REQ
		SET CERREQ_STATUS = '승인완료'
		WHERE CERT_REQNO =
		#{certReqno}
	</update>




	<select id="selectEnrollWithCertReq"
		resultMap="enrollWithCertReqMap" parameterType="string">
		SELECT
		E.ENROLL_NO
		, E.USER_NO
		, E.APPLY_DATE
		, E.IS_ATTENDED
		, E.IS_COMPLETED
		, E.IS_CERT_ISSUED
		, P.PROGRAM_NO
		, P.PROGRAM_TITLE
		, P.START_DATE
		, P.END_DATE
		, U.USER_NAME
		, R.CERT_REQNO
		, R.CERREQ_DATE
		, R.CERREQ_STATUS
		, R.CERREQ_COMMENT

		FROM PROGRAM_ENROLL E
		JOIN PROGRAM P
			ON E.PROGRAM_NO = P.PROGRAM_NO
		JOIN STUDENT S 
			ON E.USER_NO = S.USER_NO
		JOIN TB_USER U 
			ON S.USER_NO = U.USER_NO
		LEFT JOIN PROGRAM_CERT_REQ R 
			ON E.ENROLL_NO = R.ENROLL_NO

		WHERE E.ENROLL_NO = #{enrollNo}
	</select>

	<insert id="insertCertIssue"
		parameterType="kr.or.ddit.pfcp.common.vo.ProgramCertIssueVO">
		INSERT INTO PROGRAM_CERT_ISSUE (
		CERT_ISSUENO
		, CERT_REQNO
		, ISSUE_DATE
		, FILE_REF_NO
		, USER_NO
		) VALUES(
		'ISSUE' || LPAD(CERT_ISSUE_SEQ.NEXTVAL, 3, '0')
		, #{certReqno}
		, #{issueDate}
		, #{fileRefNo}
		, #{userNo}
		)
	</insert>


	<select id="selectIssueWithFileByReqno" parameterType="string"
		resultType="kr.or.ddit.pfcp.common.vo.ProgramCertIssueVO" resultMap="IssueWithFileMap">
		SELECT
		i.CERT_ISSUENO
		, I.CERT_REQNO
		, I.ISSUE_DATE
		, I.FILE_REF_NO
		, I.USER_NO
		, A.ATCH_ORIGIN_NAME
		, A.ATCH_SAVE_NAME
		, A.ATCH_MIME
		, A.ATCH_CONTENT
		, A.ATCH_SIZE
		, A.ATCH_DATE
		FROM PROGRAM_CERT_ISSUE I
		JOIN FILE_REF F ON I.FILE_REF_NO = f.FILE_REF_NO
		JOIN ATCH_FILE A ON F.ATCH_ID = A.ATCH_ID
		WHERE I.CERT_REQNO = #{certReqno}
	</select>
	
	
	<select id="selectFeedbackStatsByProgram" resultMap="programFeedbackMap" resultType="kr.or.ddit.pfcp.common.vo.ProgramFeedbackVO">
	-- STAFFPROGRAMMAPPER selectFeedbackStatsByProgram
	
		SELECT
		F.FEEDBACK_NO
		, F.FEEDBACK_ACCOUNT
		, F.FEEDBACK_COMMENT
		, F.SUBMIT_DATE
		, F.ENROLL_NO
		, E.PROGRAM_NO
		, P.PROGRAM_TITLE
		, U.USER_NAME
		, P.TYPE_CODE
		FROM PROGRAM_FEEDBACK F
		JOIN PROGRAM_ENROLL E 
			ON F.ENROLL_NO = E.ENROLL_NO
		JOIN PROGRAM P 
			ON E.PROGRAM_NO = P.PROGRAM_NO
		JOIN TB_USER U 
			ON E.USER_NO = U.USER_NO
		ORDER BY F.SUBMIT_DATE DESC
	</select>
	
	<select id="selectSatisfactionGroupedByType" resultType="map">
	  SELECT 
	    T.TYPE_CODE,
	    T.TYPE_NAME,
	    ROUND(AVG(F.FEEDBACK_ACCOUNT), 1) AS AVG_SCORE,
	    COUNT(*) AS RESPONDENT_COUNT
	  FROM PROGRAM_FEEDBACK F
	  JOIN PROGRAM_ENROLL E ON F.ENROLL_NO = E.ENROLL_NO
	  JOIN PROGRAM P ON E.PROGRAM_NO = P.PROGRAM_NO
	  JOIN TYPE T ON P.TYPE_CODE = T.TYPE_CODE
	  GROUP BY T.TYPE_CODE, T.TYPE_NAME
	  ORDER BY AVG_SCORE DESC
	</select>
	
	<!-- <select id="selectCurrentMonth"></select> -->
	
	<select id = "selectFaciltyByProgram" resultType="kr.or.ddit.pfcp.common.vo.FacilityVO">
	SELECT FACILITY_NAME
		, FACILITY_NO
	FROM FACILITY
	WHERE FACILITY_STATUS = 'AVAILABLE'
	</select>
	
	

</mapper>