package kr.or.ddit.common.util;

import java.io.ByteArrayOutputStream;
import java.io.InputStream;

import com.lowagie.text.Chunk;
import com.lowagie.text.Document;
import com.lowagie.text.Font;
import com.lowagie.text.Image;
import com.lowagie.text.PageSize;
import com.lowagie.text.Paragraph;
import com.lowagie.text.pdf.BaseFont;
import com.lowagie.text.pdf.PdfContentByte;
import com.lowagie.text.pdf.PdfWriter;

import lombok.extern.slf4j.Slf4j;

@Slf4j
public class PdfCertGenerator {

	public static byte[] generatePdf(String studentName, String programTitle, String issueDate) {
		log.info("ğŸ“„ PDF ìƒì„± ì‹œì‘: ìˆ˜ë£Œì: {}, í”„ë¡œê·¸ë¨ëª…: {}, ë°œê¸‰ì¼ì: {}", studentName, programTitle, issueDate);

		// Null-safe ê¸°ë³¸ê°’
		if (studentName == null || studentName.isBlank())
			studentName = "ìˆ˜ë£Œì ì—†ìŒ";
		if (programTitle == null || programTitle.isBlank())
			programTitle = "í”„ë¡œê·¸ë¨ëª… ì—†ìŒ";
		if (issueDate == null || issueDate.isBlank())
			issueDate = "ë°œê¸‰ì¼ì ì—†ìŒ";

		try {
			// ë¬¸ì„œ ìƒì„±
			Document document = new Document(PageSize.A4, 50, 50, 70, 50);
			ByteArrayOutputStream out = new ByteArrayOutputStream();
			PdfWriter writer = PdfWriter.getInstance(document, out);
			document.open();

			// Pretendard í°íŠ¸ ë¡œë”©
			InputStream fontStream = PdfCertGenerator.class.getResourceAsStream("/static/fonts/Pretendard-Regular.ttf");
			// ì´ë¯¸ì§€ ë°°ê²½
			InputStream imageStream = PdfCertGenerator.class
					.getResourceAsStream("/static/dist/assets/img/logo.png");

			if (imageStream == null) {
				throw new RuntimeException("ë°°ê²½ ì´ë¯¸ì§€ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
			}

			Image bgImage = Image.getInstance(imageStream.readAllBytes());

			// PDF í˜ì´ì§€ ì¤‘ì•™ ìœ„ì¹˜ ê³„ì‚°
			float x = (PageSize.A4.getWidth() - 300) / 2; // 300ì€ ì´ë¯¸ì§€ ë„ˆë¹„ ê¸°ì¤€
			// ì˜ˆ: 50pt ìœ„ë¡œ
			float y = (PageSize.A4.getHeight() - 300) / 2 + 50;


			bgImage.setAbsolutePosition(x, y);
			bgImage.scaleAbsolute(300, 300); // ì´ë¯¸ì§€ í¬ê¸° ì¡°ì ˆ (ì›í•˜ëŠ” í¬ê¸° ì¡°ì •)

			// íë¦¼ íš¨ê³¼ì²˜ëŸ¼ ë³´ì´ê²Œ íˆ¬ëª…ë„ ì¡°ì •
			bgImage.setTransparency(new int[] { 0x00, 0x10 });
			// ë°°ê²½ ë ˆì´ì–´ì— ì¶”ê°€
			PdfContentByte canvas = writer.getDirectContentUnder();
			canvas.addImage(bgImage);

			if (fontStream == null) {
				throw new RuntimeException("Pretendard í°íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
			}

			BaseFont baseFont = BaseFont.createFont("Pretendard-Regular.ttf", BaseFont.IDENTITY_H, BaseFont.EMBEDDED,
					true, fontStream.readAllBytes(), null);

			Font titleFont = new Font(baseFont, 24, Font.BOLD);
			Font bodyFont = new Font(baseFont, 13);

			// ì œëª©
			Paragraph title = new Paragraph("ë¹„êµê³¼ í”„ë¡œê·¸ë¨ ì´ìˆ˜ì¦", titleFont);
			title.setAlignment(Paragraph.ALIGN_CENTER);
			title.setSpacingAfter(30f);
			document.add(title);

			// ë³¸ë¬¸
			document.add(new Paragraph("ìˆ˜ë£Œìëª…: " + studentName, bodyFont));
			document.add(Chunk.NEWLINE);
			document.add(new Paragraph("í”„ë¡œê·¸ë¨ëª…: " + programTitle, bodyFont));
			document.add(Chunk.NEWLINE);
			document.add(new Paragraph("ë°œê¸‰ì¼ì: " + issueDate, bodyFont));
			document.add(Chunk.NEWLINE);
			document.add(bgImage);

			Paragraph desc = new Paragraph("ìœ„ ì‚¬ëŒì€ ìœ„ í”„ë¡œê·¸ë¨ì„ ì„±ì‹¤íˆ ì´ìˆ˜í•˜ì˜€ìŒì„ í™•ì¸í•˜ë©° ì´ì— ì´ìˆ˜ì¦ì„ ë°œê¸‰í•©ë‹ˆë‹¤.", bodyFont);
			desc.setSpacingBefore(30f);
			desc.setAlignment(Paragraph.ALIGN_JUSTIFIED);
			document.add(desc);

			Paragraph footer = new Paragraph("\n\n(ê¸°ê´€ëª… ë˜ëŠ” ë‹´ë‹¹ì ì„œëª…)", bodyFont);
			footer.setAlignment(Paragraph.ALIGN_RIGHT);
			document.add(footer);

			document.close();
			return out.toByteArray();

		} catch (Exception e) {
			log.error("âŒ PDF ìƒì„± ì¤‘ ì˜¤ë¥˜ ë°œìƒ", e);
			return null;
		}
	}

}
