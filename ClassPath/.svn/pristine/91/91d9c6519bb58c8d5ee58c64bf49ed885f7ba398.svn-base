<%@ page language="java" contentType="text/html; charset=UTF-8"
pageEncoding="UTF-8"%> 
<%@ taglib prefix="sec" uri="http://www.springframework.org/security/tags" %>
<%@ taglib uri="jakarta.tags.core" prefix="c"%>

<link rel="stylesheet" href="/dist/assets/css/sidebar-specific.css">

<div class="sidebar" style="background-color:#203A8A"> 
	<div class="sidebar-logo">
		<!-- Logo Header -->
		<div class="logo-header" style="background-color:#203A8A">
			<a href="/" class="logo"> 
				<img src="/dist/assets/img/kaiadmin/logo_pathFinder_white.png"
					 alt="navbar brand" class="navbar-brand" height="50" width="150" />
			</a>
			<div class="nav-toggle">
				<button class="btn btn-toggle toggle-sidebar">
					<i class="gg-menu-right"></i>
				</button>
				<button class="btn btn-toggle sidenav-toggler">
					<i class="gg-menu-left"></i>
				</button>
			</div>
			<button class="topbar-toggler more">
				<i class="gg-more-vertical-alt"></i>
			</button>
		</div>
	</div>
	
	<!-- Role Selector -->
	<div class="role-selector" style="padding: 15px;">
		<label for="roleSelector" class="visually-hidden">Select Role</label>
		<select id="roleSelector" class="form-select">
			<option value="staff">교직원</option>
			<option value="student">학생</option>
			<option value="professor">교수</option>
		</select>
	</div>
	
	<div class="sidebar-wrapper scrollbar scrollbar-inner">
		<div class="sidebar-content">
			
			<!-- Staff Menu -->
			<ul class="nav nav-secondary" id="staffMenu">
				<li class="nav-item2">
					<a data-bs-toggle="collapse" href="#memberManagement" class="collapsed" aria-expanded="false">
						<i class="fas fa-users"></i>
						<p>구성원관리</p>
						<span class="caret"></span>
					</a>
					<div class="collapse" id="memberManagement">
						<ul class="nav nav-collapse">
							<li class="nav-item2">
								<a href="/staff/studentmanage/studentList.do">
									<span class="sub-item">학생관리</span>
								</a>
							</li>
							<li class="nav-item2">
								<a href="/staff/professorManagement/professorList.do">
									<span class="sub-item">교수관리</span>
								</a>
							</li>
							<li class="nav-item2">
								<a href="/staff/staffmanage/staffmanageList.do">
									<span class="sub-item">교직원관리</span>
								</a>
							</li>
						</ul>
					</div>
				</li>
				
				<li class="nav-item2">
					<a data-bs-toggle="collapse" href="#classManagement" class="collapsed" aria-expanded="false">
						<i class="fas fa-chalkboard"></i>
						<p>수업관리</p>
						<span class="caret"></span>
					</a>
					<div class="collapse" id="classManagement">
						<ul class="nav nav-collapse">
							<li class="nav-item2">
								<a href="/staff/subject/subjectList.do">
									<span class="sub-item">교과목관리</span>
								</a>
							</li>
							<li class="nav-item2">
								<a href="/staff/grademanage/gradeList.do">
									<span class="sub-item">성적관리</span>
								</a>
							</li>
							<li class="nav-item2">
								<a href="/staff/lectureEvaluation/lectureEvalutaionForm.do">
									<span class="sub-item">강의평가</span>
								</a>
							</li>
							<li class="nav-item2">
								<a href="/staff/lecturemanage/lecture/lectureList.do">
									<span class="sub-item">출석관리</span>
								</a>
							</li>
						</ul>
					</div>
				</li>
				
				<li class="nav-item2">
					<a data-bs-toggle="collapse" href="#studentSupport" class="collapsed" aria-expanded="false">
						<i class="fas fa-hands-helping"></i>
						<p>학생지원</p>
						<span class="caret"></span>
					</a>
					<div class="collapse" id="studentSupport">
						<ul class="nav nav-collapse">
							<li class="nav-item2">
								<a href="/staff/consult/consultScheduleList.do">
									<span class="sub-item">상담</span>
								</a>
							</li>
							<li class="nav-item2">
								<a href="/staff/scholarship/staffScholarshipList.do">
									<span class="sub-item">장학</span>
								</a>
							</li>
							<li class="nav-item2">
								<a href="/staff/applyGrd/graduateApply.do">
									<span class="sub-item">졸업신청</span>
								</a>
							</li>
							<li class="nav-item2">
								<a href="/staff/requestCollection/requestCollection.do">
									<span class="sub-item">학적변경신청</span>
								</a>
							</li>
							<li class="nav-item2">
								<a href="/staff/program/programList.do">
									<span class="sub-item">비교과</span>
								</a>
							</li>
						</ul>
					</div>
				</li>
				
				<li class="nav-item2">
					<a data-bs-toggle="collapse" href="#academicAdmin" class="collapsed" aria-expanded="false">
						<i class="fas fa-file-signature"></i>
						<p>학사행정</p>
						<span class="caret"></span>
					</a>
					<div class="collapse" id="academicAdmin">
						<ul class="nav nav-collapse">
							<li class="nav-item2">
								<a href="/staff/tuition/tuitionList.do">
									<span class="sub-item">등록금</span>
								</a>
							</li>
							<li class="nav-item2">
								<a href="/staff/certification/certificationFormList.do">
									<span class="sub-item">증명서</span>
								</a>
							</li>
						</ul>
					</div>
				</li>
				
				<li class="nav-item2">
					<a href="/staff/thesis/thesisList.do">
						<i class="fas fa-file-alt"></i>
						<p>논문관리</p>
					</a>
				</li>
					
				<li class="nav-item2">
					<a href="/staff/facility/facilityList.do">
						<i class="fas fa-building"></i>
						<p>시설</p>
					</a>
				</li>
				
				<li class="nav-item2">
					<a data-bs-toggle="collapse" href="#infoManagement" class="collapsed" aria-expanded="false">
						<i class="fas fa-info-circle"></i>
						<p>정보관리</p>
						<span class="caret"></span>
					</a>
					<div class="collapse" id="infoManagement">
						<ul class="nav nav-collapse">
							<li class="nav-item2">
								<a href="/staff/notice/noticeList.do">
									<span class="sub-item">공지사항</span>
								</a>
							</li>
							<li class="nav-item2">
								<a href="/staff/college/collegeList.do">
									<span class="sub-item">단과대학</span>
								</a>
							</li>
							<li class="nav-item2">
								<a href="#">
									<span class="sub-item">통계</span>
								</a>
							</li>
						</ul>
					</div>
				</li>
				
				<li class="nav-item2">
					<a href="/schedule.do">
						<i class="fas fa-calendar"></i>
						<p>캘린더</p>
					</a>
				</li>
				
				<li class="nav-item2">
					<a href="#" data-bs-toggle="modal" data-bs-target="#alarm">
						<i class="fas fa-bell"></i>
						<p>알림 보내기</p>
					</a>
				</li>
			</ul>

			<!-- Student Menu -->
			<ul class="nav nav-secondary" id="studentMenu" style="display: none;">
				<li class="nav-item2 active">
					<a href="/student/lecture/enroll.do">
						<i class="fas fa-plus-circle"></i>
						<p>수강신청</p>
					</a>
				</li>
				<li class="nav-item2">
					<a data-bs-toggle="collapse" href="#gradeManagement" class="collapsed" aria-expanded="false">
						<i class="fas fa-chart-line"></i>
						<p>성적관리</p>
						<span class="caret"></span>
					</a>
					<div class="collapse" id="gradeManagement">
						<ul class="nav nav-collapse">
							<li class="nav-item2">
								<a href="/student/grade/history.do">
									<span class="sub-item">성적 조회</span>
								</a>
							</li>
							<li class="nav-item2">
								<a href="/student/grade/appeal.do">
									<span class="sub-item">이의 신청</span>
								</a>
							</li>
						</ul>
						 
					</div>
				</li>
				<li class="nav-item2">
					<a href="/student/selectLecture.do">
						<i class="fas fa-star"></i>
						<p>강의평가</p>
					</a>
				</li>
				<li class="nav-item2">
					<a data-bs-toggle="collapse" href="#studentState" class="collapsed" aria-expanded="false">
						<i class="fas fa-id-card"></i>
						<p>학적</p>
						<span class="caret"></span>
					</a>
					<div class="collapse" id="studentState">
						<ul class="nav nav-collapse">
							<li class="nav-item2">
								<a href="/student/counsel/majorChangeList.do">
									<span class="sub-item">전공 변경</span>
								</a>
							</li>
							<li class="nav-item2">
								<a href="/student/counsel/doubleMajorList.do">
									<span class="sub-item">복수 전공</span>
								</a>
							</li>
							<li class="nav-item2">
								<a href="/student/counsel/leaveApplyList.do">
									<span class="sub-item">휴학</span>
								</a>
							</li>
							<li class="nav-item2">
								<a href="/student/counsel/returnApplyList.do">
									<span class="sub-item">복학</span>
								</a>
							</li>
							<li class="nav-item2">
								<a href="/student/counsel/graduationSuspensionList.do">
									<span class="sub-item">졸업 유예</span>
								</a>
							</li>
						</ul>
					</div>
				</li>
				<li class="nav-item2">
					<a href="/student/tuition/tuitionPolicy">
						<i class="fas fa-user-plus"></i>
						<p>등록</p>
					</a>
				</li>
				<li class="nav-item2">
					<a href="/student/scholarship/scholarshipBenefit.do">
						<i class="fas fa-graduation-cap"></i>
						<p>장학</p>
					</a>
				</li>
				<li class="nav-item2">
					<a href="/student/certificate/issuedCertificateHistory.do">
						<i class="fas fa-certificate"></i>
						<p>증명서</p>
					</a>
				</li>
				<li class="nav-item2">
					<a data-bs-toggle="collapse" href="#studentCounsel" class="collapsed" aria-expanded="false">
						<i class="fas fa-comments"></i>
						<p>상담</p>
						<span class="caret"></span>
					</a>
					<div class="collapse" id="studentCounsel">
						<ul class="nav nav-collapse">
							<li class="nav-item2">
								<a href="/student/counsel/departmentCounsel/departmentCounsel.do">
									<span class="sub-item">학과 상담</span>
								</a>
							</li>
							<li class="nav-item2">
								<a href="/student/counsel/employmentCounsel/employmentCounsel.do">
									<span class="sub-item">취업 상담</span>
								</a>
							</li>
						</ul>
					</div>
				</li>
				<li class="nav-item2">
					<a href="#">
						<i class="fas fa-handshake"></i>
						<p>취업·멘토링</p>
					</a>
				</li>
				<li class="nav-item2">
					<a data-bs-toggle="collapse" href="#studentProgram" class="collapsed" aria-expanded="false">
						<i class="fas fa-puzzle-piece"></i>
						<p>비교과</p>
						<span class="caret"></span>
					</a>
					<div class="collapse" id="studentProgram">
						<ul class="nav nav-collapse">
							<li class="nav-item2">
								<a href="/student/program/programApplList.do">
									<span class="sub-item">비교과 신청</span>
								</a>
							</li>
							<li class="nav-item2">
								<a href="/student/program/myParticipationList.do">
									<span class="sub-item">내 비교과 프로그램</span>
								</a>
							</li>
						</ul>
					</div>
				</li>
				<li class="nav-item2">
					<a href="/student/facility/studentFacilityList.do">
						<i class="fas fa-building"></i>
						<p>시설예약</p>
					</a>
				</li>
				<li class="nav-item2">
					<a href="/student/notice/noticeList.do">
						<i class="fas fa-bullhorn"></i>
						<p>공지사항</p>
					</a>
				</li>
				<!-- 로그인 안한 사용자는 안보이게 해놨습니다. 이하 동일 -->
				<sec:authorize access="isAuthenticated()">
					<li class="nav-item2">
						<a href="http://localhost:6060/eclass/lecture/<sec:authentication property="principal.username"/>">
							<i class="fas fa-laptop"></i>
							<p>사이버 강의실</p>
						</a>
					</li>
				</sec:authorize>
				<li class="nav-item2">
					<a href="/schedule.do">
						<i class="fas fa-calendar"></i>
						<p>캘린더</p>
					</a>
				</li>
			</ul>

			<!-- Professor Menu -->
			<ul class="nav nav-secondary" id="professorMenu" style="display: none;">
				<li class="nav-item2 active">
					<a href="/professor/lecture/lectureList.do">
						<i class="fas fa-book-open"></i>
						<p>강의 개설신청</p>
					</a>
				</li>
				<li class="nav-item2">
					<a href="/professor/attendclass/attendclassList.do">
						<i class="fas fa-chalkboard"></i>
						<p>강의관리</p>
					</a>
				</li>
				<li class="nav-item2">
					<a href="/professor/exam/examList.do">
						<i class="fas fa-pencil-alt"></i>
						<p>시험관리</p>
					</a>
				</li>
				<li class="nav-item2">
					<a href="http://localhost:6060/eclass">
						<i class="fas fa-folder-open"></i>
						<p>과제관리</p>
					</a>
				</li>
				<li class="nav-item2">
					<a href="/professor/attendance/attendclassList.do">
						<i class="fas fa-clipboard-check"></i>
						<p>출석관리</p>
					</a>
				</li>
				<li class="nav-item2">
					<a href="/professor/grade/attendclassList.do">
						<i class="fas fa-chart-line"></i>
						<p>성적관리</p>
					</a>
				</li>
				<li class="nav-item2">
					<a href="/professor/evaluation/attendclassList.do">
						<i class="fas fa-star"></i>
						<p>강의평가</p>
					</a>
				</li>
				<li class="nav-item2">
					<a href="/professor/thesis/thesisList.do">
						<i class="fas fa-file-alt"></i>
						<p>논문관리</p>
					</a>
				</li>
				<li class="nav-item2">
					<a href="/schedule.do">
						<i class="fas fa-calendar"></i>
						<p>캘린더</p>
					</a>
				</li>
				<li class="nav-item2">
					<a href="/professor/dataManagement/data.do">
						<i class="fas fa-database"></i>
						<p>데이터관리</p>
					</a>
				</li>
				<li class="nav-item2">
					<a href="/staff/program/programList.do">
						<i class="fas fa-puzzle-piece"></i>
						<p>비교과관리</p>
					</a>
				</li>
				</li>
				<sec:authorize access="isAuthenticated()">
					<li class="nav-item2">
						<a href="http://localhost:6060/eclass/lecture/<sec:authentication property="principal.username"/>"> 
							<i class="fas fa-laptop"></i>
							<p>사이버 강의실</p>
						</a>
					</li>
				</sec:authorize>
			</ul>
		</div>
	</div>
</div>

<div class="modal fade" id="alarm" tabindex="-1" aria-hidden="true">
	<div class="modal-dialog modal-dialog-scrollable">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title">알림 전송</h5>
			</div>
			
			<div class="modal-body">
				<label>보낼 대상</label>
				<div class="d-flex gap-3 mb-3">
					<div class="form-check form-check-inline">
						<input class="form-check-input" type="checkbox" id="targetStudent" name="targetRole" value="student">
						<label class="form-check-label" for="targetStudent">학생</label>
					</div>
					<div class="form-check form-check-inline">
						<input class="form-check-input" type="checkbox" id="targetProfessor" name="targetRole" value="professor">
						<label class="form-check-label" for="targetProfessor">교수</label>
					</div>
					<div class="form-check form-check-inline">
						<input class="form-check-input" type="checkbox" id="targetStaff" name="targetRole" value="staff">
						<label class="form-check-label" for="targetStaff">교직원</label>
					</div>
				</div>
				<label>내용</label>
				<textarea id="notificationMessage" class="textareaField" rows="15" cols="" style="resize: none;"></textarea>
			</div>
			
			<div class="modal-footer">
				<button type="button" class="btn submitButton" id="sendBtn">전송</button>
				<button type="button" class="btn deleteButton" data-bs-dismiss="modal">닫기</button>
			</div>
		</div>
	</div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
	const roleSelector = document.getElementById('roleSelector');
	const menus = {
		staff: document.getElementById('staffMenu'),
		student: document.getElementById('studentMenu'),
		professor: document.getElementById('professorMenu')
	};

	function closeAllCollapses() {
		document.querySelectorAll('.collapse.show').forEach(el => el.classList.remove('show'));
		document.querySelectorAll('[data-bs-toggle="collapse"]').forEach(el => {
			el.classList.add('collapsed');
			el.setAttribute('aria-expanded', 'false');
		});
	}

	function deactivateAllMenuItems() {
		document.querySelectorAll('.nav-item2').forEach(item => item.classList.remove('active'));
	}

	function showOnlyMenu(role) {
		// hide all
		Object.values(menus).forEach(menu => {
			if (menu) menu.style.display = 'none';
		});

		// show selected
		const currentMenu = menus[role];
		if (currentMenu) {
			currentMenu.style.display = 'block';

			// optional: set first item active
			const firstItem = currentMenu.querySelector('.nav-item2:not(.collapse):not(.nav-collapse)');
			if (firstItem) firstItem.classList.add('active');
		}
	}

	// 1. 초기 설정
	const savedRole = localStorage.getItem('selectedRole') || 'staff';
	roleSelector.value = savedRole;
	showOnlyMenu(savedRole);
	closeAllCollapses();
	deactivateAllMenuItems();

	// 2. 역할 변경 이벤트
	roleSelector.addEventListener('change', function () {
		const selectedRole = this.value;
		localStorage.setItem('selectedRole', selectedRole);
		showOnlyMenu(selectedRole);
		closeAllCollapses();
		deactivateAllMenuItems();
	});

	// 3. 메뉴 클릭 시 active 처리
	document.addEventListener('click', function (e) {
		const navLink = e.target.closest('.nav-item2 > a[href]:not([data-bs-toggle="collapse"])');
		if (navLink) {
			deactivateAllMenuItems();
			const navItem = navLink.closest('.nav-item2');
			if (navItem) navItem.classList.add('active');
		}
	});
	
	// 알림 보내기
	document.querySelector('#sendBtn').addEventListener('click', function() {
		const message = document.getElementById('notificationMessage').value.trim();
		const checkedRoles = Array.from(document.querySelectorAll('input[name="targetRole"]:checked')).map(cb => cb.value);
		
		if (checkedRoles.length === 0) {
			alert('보낼 대상을 선택하세요.');
			return;
		}
		
		if (!message) {
			alert('메시지를 입력하세요.');
			return;
		}
		
		console.log("fetch 실행 직전");
		
		fetch('/sendNotification.do', {
			method: 'POST',
			headers: {
				'Content-Type': 'application/json'
			},
			body: JSON.stringify({
				roles: checkedRoles,
				message: message,
				linkUrl: '#'
			})
		}).then(resp => {
			console.log("체킁 :", resp);
			
			if (resp.ok) {

				return resp.text();
			} else {
			
				throw new Error('서버 에러');
			}
		}).then(result => {
			alert('알림 전송되었습니다.');
			  
			const alarmModal = bootstrap.Modal.getInstance(document.getElementById('alarm'));
			  
			alarmModal.hide();
			  
			document.getElementById('notificationMessage').value = '';

			document.querySelectorAll('input[name="targetRole"]:checked').forEach(cb => cb.checked = false);
		}).catch(err => {
			alert('알림 전송 실패: ' + err.message);
		});
	});
});
</script>
