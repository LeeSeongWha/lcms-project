<%@ page contentType="text/html; charset=UTF-8"%>
<%@ taglib prefix="c" uri="jakarta.tags.core"%>
<link rel="stylesheet" href="/dist/assets/css/bodyFormat.css" />

<h2 class="sectionTitle">비교과 프로그램 이수증 발급 처리</h2>
<div class="section">
	<div class="card">
		<h3 class="sectionTitle">신청자 기본 정보</h3>
		<div class="form-row" style="display: flex; gap: 20px;">
			<div class="form-group" style="flex: 1;">
				<label class="inputLabel">신청자 이름</label> <input type="text"
					class="inputField" value="${enroll.student.user.userName}" readonly />
			</div>
			<div class="form-group" style="flex: 1;">
				<label class="inputLabel">학번</label> <input type="text"
					class="inputField" value="${enroll.userNo}" readonly />
			</div>
			<div class="form-group" style="flex: 1;">
				<label class="inputLabel">신청일</label> <input type="text"
					class="inputField" value="${enroll.applyDate}" readonly />
			</div>
		</div>

		<div class="form-row" style="display: flex; gap: 20px;">
			<div class="form-group" style="flex: 1;">
				<label class="inputLabel">프로그램명</label> <input type="text"
					class="inputField" value="${enroll.program.programTitle}" readonly />
			</div>
			<div class="form-group" style="flex: 1;">
				<label class="inputLabel">프로그램 기간</label> <input type="text"
					class="inputField"
					value="${enroll.program.startDate} ~ ${enroll.program.endDate}"
					readonly />
			</div>
			<div class="form-group" style="flex: 1;">
				<label class="inputLabel">신청 상태</label> <span
					class="badge badgeBlue">${enroll.programcert.cerreqStatus}</span>
			</div>
		</div>
	</div>

	<div class="card">
		<h3 class="sectionTitle">이수증 발급 처리</h3>
		<form action="/staff/program/cert/submit" method="post"
			enctype="multipart/form-data">
			<input type="hidden" name="enrollNo" value="${enroll.enrollNo}" />

			<div class="form-group">
				<label class="inputLabel">발급 메모 (선택사항)</label>
				<textarea name="certMemo" class="inputField" rows="4"
					placeholder="발급 관련 메모사항을 입력하세요...">${enroll.programcert.cerreqComment}</textarea>
			</div>

			<div class="button-group" style="margin-top: 20px;">
				<c:if
					test="${e.isCompleted eq 'Y' && e.programcert.cerreqStatus eq '대기'}">
					<button class="submitButton"
						onclick="issueCertificate('${e.programcert.certReqno}')">발급하기</button>
				</c:if>
				<button type="button" class="cancelButton" onclick="history.back()">목록으로
					돌아가기</button>
			</div>
		</form>
	</div>
</div>
<<script type="text/javascript">
function issueCertificate(certReqno) {
    if (!confirm("이수증을 발급하시겠습니까?")) return;

    fetch(`/staff/program/cert/issue?certReqno=` + certReqno, {
        method: 'POST'
    })
    .then(res => {
        if (res.ok) {
            alert("이수증 발급 완료!");
            location.reload(); // 혹은 location.href = '/staff/program/applyManage'; 등으로 이동
        } else {
            alert("발급 처리 실패");
        }
    })
    .catch(err => {
        console.error("서버 오류", err);
        alert("서버 오류가 발생했습니다.");
    });
}
</script>
</body>
</html>