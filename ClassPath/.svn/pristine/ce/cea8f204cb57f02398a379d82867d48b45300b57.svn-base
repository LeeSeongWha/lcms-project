<%@ page language="java" contentType="text/html; charset=UTF-8"
	pageEncoding="UTF-8"%>
<%@ taglib uri="jakarta.tags.core" prefix="c"%>
<%@ taglib prefix="fn" uri="http://java.sun.com/jsp/jstl/functions"%>
<link rel="stylesheet" href="/dist/assets/css/bodyFormat.css">
<title>ì‹œì„¤ ì˜ˆì•½</title>

<c:set var="days" value="${fn:split('MON,TUE,WED,THU,FRI', ',')}" />
<c:set var="dayNames" value="${fn:split('ì›”ìš”ì¼,í™”ìš”ì¼,ìˆ˜ìš”ì¼,ëª©ìš”ì¼,ê¸ˆìš”ì¼', ',')}" />

<body class="bg-light text-dark font-sans">

	<div class="container my-5 p-4 bg-white rounded shadow">
		<h2 class="text-center fw-bold mb-4 pageTitle">ì‹œì„¤ ì˜ˆì•½</h2>

		<!-- ì‹œì„¤ ì •ë³´ -->
		<div class="text-center mb-4 p-4 card border-primary">
			<h3 id="facilityName" class="fw-bold text-primary mb-2">
				${facility.facilityName} <span class="fw-normal text-muted">
					- ${facility.location}</span>
			</h3>
			<p id="facilityInfo" class="text-secondary mb-0">
				${facility.facilityType} / ${facility.facilityMp}ì¸ ì‚¬ìš© ê°€ëŠ¥</p>
		</div>

		<!-- ì˜ˆì•½ ì•ˆë‚´ -->
		<div class="noticeBox noticeInfo text-center mb-4">ğŸ’¡ ì˜ˆì•½ ì•ˆë‚´: íŒŒë€ìƒ‰
			ì‹œê°„ëŒ€ë¥¼ í´ë¦­í•˜ì—¬ ì˜ˆì•½í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤. í•œ ë²ˆì— ìµœëŒ€ 2ì‹œê°„ê¹Œì§€ ì—°ì† ì˜ˆì•½ ê°€ëŠ¥í•©ë‹ˆë‹¤.</div>

		<!-- ì˜ˆì•½ ê°€ëŠ¥ ì‹œê°„í‘œ -->
		<div class="border-top pt-4 mt-4">
			<h3 class="sectionTitle">ì˜ˆì•½ ê°€ëŠ¥ ì‹œê°„í‘œ</h3>

			<div class="tableContainer">
				<table class="defaultTable table table-bordered text-center">
					<thead class="tableHead">
						<tr>
							<th class="tableTh">ì‹œê°„</th>
							<c:forEach var="dayName" items="${dayNames}">
								<th class="tableTh">${dayName}</th>
							</c:forEach>
						</tr>
					</thead>
					<tbody>
						<c:forEach var="hour" begin="9" end="17">
							<tr>
								<td class="tableTd bg-light fw-bold">${hour}:00-
									${hour+1}:00</td>
								<c:forEach var="day" items="${days}">
									<!-- ì˜ˆì•½ ê°€ëŠ¥ ì‹œê°„ëŒ€ì¸ì§€ í™•ì¸ -->
									<c:set var="found" value="false" />
									<c:forEach var="item" items="${facilityRT}">
										<c:if
											test="${item.reservationDay eq day && item.startHour eq hour}">
											<c:set var="found" value="true" />
										</c:if>
									</c:forEach>

									<!-- ì´ë¯¸ ì˜ˆì•½ëœ ì‹œê°„ì¸ì§€ í™•ì¸ -->
									<c:set var="reservedKey" value="${day}_${hour}" />
									<c:choose>
										<c:when test="${found and not fn:contains(reservedTimes, reservedKey)}">
											<!-- ì˜ˆì•½ ê°€ëŠ¥ -->
											<td class="tableTd text-primary fw-medium reservation-slot"
												style="background-color: #bee3f8; cursor: pointer;"
												onclick="selectTimeSlot(this, '${day}', ${hour})"
												data-day="${day}" data-hour="${hour}"><span>ì˜ˆì•½ê°€ëŠ¥</span>
											</td>
										</c:when>
										<c:otherwise>
											<!-- ì˜ˆì•½ ë¶ˆê°€ -->
											<td class="tableTd bg-secondary text-white" data-day="${day}"
												data-hour="${hour}"><span>ì˜ˆì•½ë¶ˆê°€</span></td>
										</c:otherwise>
									</c:choose>
								</c:forEach>
							</tr>
						</c:forEach>
					</tbody>
				</table>
			</div>

			<!-- ë²”ë¡€ -->
			<div class="d-flex justify-content-center gap-4 mt-4">
				<div class="d-flex align-items-center">
					<div class="me-2"
						style="width: 16px; height: 16px; background-color: #bee3f8; border: 1px solid #ccc;"></div>
					<span class="text-muted small">ì˜ˆì•½ ê°€ëŠ¥</span>
				</div>
				<div class="d-flex align-items-center">
					<div class="me-2"
						style="width: 16px; height: 16px; background-color: #6c757d; border: 1px solid #ccc;"></div>
					<span class="text-muted small">ì˜ˆì•½ ë¶ˆê°€</span>
				</div>
				<div class="d-flex align-items-center">
					<div class="me-2"
						style="width: 16px; height: 16px; background-color: #28a745; border: 1px solid #ccc;"></div>
					<span class="text-muted small">ì„ íƒëœ ì‹œê°„</span>
				</div>
			</div>
		</div>

		<!-- ì„ íƒëœ ì˜ˆì•½ ì •ë³´ -->
		<div id="selectedInfo" class="mt-4 p-3 bg-light rounded d-none">
			<h4 class="fw-bold mb-3">ì„ íƒëœ ì˜ˆì•½ ì •ë³´</h4>
			<div class="row">
				<div class="col-md-6">
					<p>
						<strong>ì‹œì„¤ëª…:</strong> ${facility.facilityName}
					</p>
					<p>
						<strong>ìœ„ì¹˜:</strong> ${facility.location}
					</p>
				</div>
				<div class="col-md-6">
					<p>
						<strong>ì„ íƒëœ ì‹œê°„:</strong> <span id="selectedTime"></span>
					</p>
					<p>
						<strong>ì´ ì˜ˆì•½ ì‹œê°„:</strong> <span id="totalHours">0</span>ì‹œê°„
					</p>
				</div>
			</div>
		</div>

		<!-- ë²„íŠ¼ ì˜ì—­ -->
		<div class="text-center mt-5">
			<button onclick="goBack()" class="cancelButton me-2">ëª©ë¡ìœ¼ë¡œ</button>
			<button id="reserveButton" onclick="submitReservation()"
				class="submitButton d-none">ì˜ˆì•½í•˜ê¸°</button>
		</div>

		<!-- ë‚˜ì˜ ì˜ˆì•½ ëª©ë¡ (ì·¨ì†Œìš©) -->
		<c:if test="${not empty myReservations}">
			<div class="mt-5">
				<h4 class="fw-bold mb-3">ë‚´ ì˜ˆì•½ ëª©ë¡</h4>
				<table class="table table-bordered text-center">
					<thead>
						<tr>
							<th>ì˜ˆì•½ì¼ì‹œ</th>
							<th>ì·¨ì†Œ</th>
						</tr>
					</thead>
					<tbody id="reservationTableBody">
						<c:forEach var="reservation" items="${myReservations}">
							<tr id="reservation-${reservation.reservationNo}">
								<td>${reservation.preferredDate}</td>
								<td>
									<button type="button" class="btn btn-danger btn-sm"
										onclick="cancelReservation('${reservation.reservationNo}')">
										ì·¨ì†Œ
									</button>
								</td>
							</tr>
						</c:forEach>
					</tbody>
				</table>
			</div>
		</c:if>
	</div>

	<script>
		let selectedSlots = [];
		let selectedSlotsData = [];

		function goBack() {
			window.location.href = "/student/facility/studentFacilityList.do";
		}

		function selectTimeSlot(cell, day, hour) {
			const key = day + '_' + hour;
			const span = cell.querySelector('span');
			
			if (span.textContent === 'ì˜ˆì•½ê°€ëŠ¥') {
				// ì´ë¯¸ ì„ íƒëœ ì‹œê°„ì¸ì§€ í™•ì¸
				const index = selectedSlots.indexOf(key);
				if (index > -1) {
					// ì„ íƒ í•´ì œ
					selectedSlots.splice(index, 1);
					selectedSlotsData.splice(index, 1);
					span.textContent = 'ì˜ˆì•½ê°€ëŠ¥';
					span.className = 'text-primary fw-medium';
					cell.style.backgroundColor = '#bee3f8';
				} else {
					// ìµœëŒ€ 2ì‹œê°„ê¹Œì§€ë§Œ ì„ íƒ ê°€ëŠ¥
					if (selectedSlots.length >= 2) {
						alert('ìµœëŒ€ 2ì‹œê°„ê¹Œì§€ë§Œ ì—°ì† ì˜ˆì•½ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
						return;
					}
					
					// ì„ íƒ ì¶”ê°€
					selectedSlots.push(key);
					selectedSlotsData.push({day: day, hour: hour});
					span.textContent = 'ì„ íƒë¨';
					span.className = 'text-white fw-medium';
					cell.style.backgroundColor = '#28a745';
				}
				
				updateSelectedInfo();
			}
		}

		function updateSelectedInfo() {
			const selectedInfo = document.getElementById('selectedInfo');
			const reserveButton = document.getElementById('reserveButton');

			if (selectedSlots.length > 0) {
				selectedInfo.classList.remove('d-none');
				reserveButton.classList.remove('d-none');

				const dayNames = {'MON': 'ì›”ìš”ì¼', 'TUE': 'í™”ìš”ì¼', 'WED': 'ìˆ˜ìš”ì¼', 'THU': 'ëª©ìš”ì¼', 'FRI': 'ê¸ˆìš”ì¼'};
				let timeText = '';

				selectedSlotsData.sort((a, b) => {
					if (a.day !== b.day) return 0;
					return a.hour - b.hour;
				});

				selectedSlotsData.forEach((slot, index) => {
					if (index > 0) timeText += ', ';
					timeText += dayNames[slot.day] + ' ' + slot.hour + ':00-' + (slot.hour + 1) + ':00';
				});

				document.getElementById('selectedTime').textContent = timeText;
				document.getElementById('totalHours').textContent = selectedSlots.length;

			} else {
				selectedInfo.classList.add('d-none');
				reserveButton.classList.add('d-none');
			}
		}
		
		function submitReservation() {
			if (selectedSlots.length === 0) {
				alert('ì˜ˆì•½í•  ì‹œê°„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
				return;
			}

			const formData = new FormData();
			formData.append('facilityNo', '${facility.facilityNo}');
			formData.append('selectedSlots', JSON.stringify(selectedSlotsData));

			if (confirm('ì˜ˆì•½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
				fetch('/student/facility/reserve', {
					method: 'POST',
					body: formData
				})
				.then(response => response.json())
				.then(data => {
					if (data.success) {
						alert('ì˜ˆì•½ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
						window.location.reload();
					} else {
						alert('ì˜ˆì•½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + (data.message || ''));
					}
				})
				.catch(error => {
					console.error('Error:', error);
					alert('ì˜ˆì•½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
				});
			}
		}

		// ë¹„ë™ê¸° ì˜ˆì•½ ì·¨ì†Œ í•¨ìˆ˜
		function cancelReservation(reservationNo) {
			console.log('cancelReservation í•¨ìˆ˜ í˜¸ì¶œë¨, reservationNo:', reservationNo);
			
			if (!confirm('ì •ë§ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
				console.log('ì‚¬ìš©ìê°€ ì·¨ì†Œë¥¼ ì„ íƒí•¨');
				return;
			}

			// ë²„íŠ¼ ë¹„í™œì„±í™” (ì¤‘ë³µ í´ë¦­ ë°©ì§€)
			const cancelButton = event.target; // onclickìœ¼ë¡œ í˜¸ì¶œëœ ë²„íŠ¼
			const originalText = cancelButton.textContent;
			cancelButton.disabled = true;
			cancelButton.textContent = 'ì·¨ì†Œ ì¤‘...';
			
			console.log('ë²„íŠ¼ ìƒíƒœ ë³€ê²½ ì™„ë£Œ');

			const formData = new FormData();
			formData.append('reservationNo', reservationNo);
			
			console.log('FormData ìƒì„± ì™„ë£Œ:', reservationNo);

			fetch('/student/facility/cancel', {
				method: 'POST',
				body: formData
			})
			.then(response => {
				console.log('ì‘ë‹µ ìˆ˜ì‹ :', response.status);
				if (!response.ok) {
					throw new Error(`HTTP error! status: ${response.status}`);
				}
				return response.json();
			})
			.then(data => {
				console.log('ì‘ë‹µ ë°ì´í„°:', data);
				if (data.success) {
					alert(data.message);
					// í•´ë‹¹ ì˜ˆì•½ í–‰ì„ DOMì—ì„œ ì œê±°
					const reservationRow = document.getElementById(`reservation-${reservationNo}`);
					if (reservationRow) {
						reservationRow.remove();
						console.log('ì˜ˆì•½ í–‰ ì œê±° ì™„ë£Œ');
					}
					window.location.reload();
					
					// ì˜ˆì•½ ëª©ë¡ì´ ëª¨ë‘ ì‚­ì œë˜ì—ˆëŠ”ì§€ í™•ì¸
					const tableBody = document.getElementById('reservationTableBody');
					if (tableBody && tableBody.children.length === 0) {
						// ì˜ˆì•½ ëª©ë¡ ì„¹ì…˜ ì „ì²´ë¥¼ ìˆ¨ê¹€
						const reservationSection = tableBody.closest('.mt-5');
						if (reservationSection) {
							reservationSection.style.display = 'none';
						}
					}
				} else {
					alert(data.message || 'ì˜ˆì•½ ì·¨ì†Œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
					// ë²„íŠ¼ ìƒíƒœ ë³µì›
					cancelButton.disabled = false;
					cancelButton.textContent = originalText;
				}
			})
			.catch(error => {
				console.error('Error:', error);
				alert('ì˜ˆì•½ ì·¨ì†Œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
				// ë²„íŠ¼ ìƒíƒœ ë³µì›
				cancelButton.disabled = false;
				cancelButton.textContent = originalText;
			});
		}
	</script>
</body>
</html>