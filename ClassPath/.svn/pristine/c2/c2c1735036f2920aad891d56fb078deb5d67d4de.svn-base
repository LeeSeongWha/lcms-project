<%@ page language="java" contentType="text/html; charset=UTF-8"
	pageEncoding="UTF-8"%>
<%@ taglib uri="jakarta.tags.core" prefix="c"%>
<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>시설 예약 가능 시간 설정</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="/dist/assets/css/bodyFormat.css">   
</head>

<body class="bg-gray-100 text-gray-800 font-sans antialiased">

	<div class="max-w-6xl mx-auto my-12 p-8 bg-white rounded-xl shadow-lg">
		<h2 class="text-3xl font-extrabold text-center text-gray-900 mb-8">시설 예약 가능 시간 설정</h2>

		<div class="text-center mb-8 p-4 bg-blue-50 rounded-lg">
			<h3 id="facilityName" class="text-xl font-bold text-blue-700 mb-1">
				${facility.facilityName } <span class="font-normal text-gray-600">-
					${facility.location }</span>
			</h3>
			<p id="facilityInfo" class="text-sm text-gray-500">
				${facility.facilityType } / ${facility.facilityMp }인 사용 가능</p>
		</div>

		<!-- 수정 모드 안내 -->
		<c:if test="${mode == 'edit'}">
			<div class="mb-6 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
				<p class="text-yellow-800 font-medium text-center">
					📝 수정 모드: 시간표의 셀을 클릭하여 예약 가능 시간을 설정하세요.
				</p>
			</div>
		</c:if>

		<div class="border-t border-gray-200 pt-8 mt-8">
			<h3 class="text-xl font-semibold text-gray-800 mb-6">예약 가능 시간표</h3>

			<!-- 시간표 테이블 -->
			<div class="overflow-x-auto">
				<table
					class="w-full border-collapse border border-gray-300 rounded-lg overflow-hidden shadow-sm">
					<thead>
						<tr class="bg-gray-50">
							<th
								class="border border-gray-300 p-3 text-center font-semibold text-gray-700 bg-gray-100">시간</th>
							<th
								class="border border-gray-300 p-3 text-center font-semibold text-gray-700">월요일</th>
							<th
								class="border border-gray-300 p-3 text-center font-semibold text-gray-700">화요일</th>
							<th
								class="border border-gray-300 p-3 text-center font-semibold text-gray-700">수요일</th>
							<th
								class="border border-gray-300 p-3 text-center font-semibold text-gray-700">목요일</th>
							<th
								class="border border-gray-300 p-3 text-center font-semibold text-gray-700">금요일</th>
						</tr>
					</thead>
					<tbody>
						<c:forEach var="hour" begin="9" end="17">
							<tr>
								<td
									class="border border-gray-300 p-3 text-center font-medium bg-gray-50">
									${hour}:00-${hour+1}:00</td>
								
								<!-- 월요일 -->
								<td
									class="border border-gray-300 p-3 text-center relative
<c:set var="found" value="false"/>
<c:forEach items="${facilityRT}" var="item">
<c:if test="${item.reservationDay eq 'MON' && item.startHour eq hour}">
<c:set var="found" value="true"/>
</c:if>
</c:forEach>
<c:choose>
<c:when test="${found}">bg-blue-200 hover:bg-blue-300</c:when>
<c:otherwise>bg-white hover:bg-gray-100</c:otherwise>
</c:choose>
<c:if test="${mode == 'edit'}"> cursor-pointer transition-colors duration-200</c:if>
"
									<c:if test="${mode == 'edit'}">
										onclick="toggleTimeSlot(this, 'MON', ${hour})"
									</c:if>
									data-day="MON" data-hour="${hour}">
									<c:set var="found" value="false" />
									<c:forEach items="${facilityRT}" var="item">
										<c:if test="${item.reservationDay eq 'MON' && item.startHour eq hour}">
											<span class="text-blue-700 font-medium">예약가능</span>
											<c:set var="found" value="true" />
										</c:if>
									</c:forEach>
									<c:if test="${!found}">
										<span class="text-gray-400">-</span>
									</c:if>
								</td>
								
								<!-- 화요일 -->
								<td
									class="border border-gray-300 p-3 text-center relative
<c:set var="found" value="false"/>
<c:forEach items="${facilityRT}" var="item">
<c:if test="${item.reservationDay eq 'TUE' && item.startHour eq hour}">
<c:set var="found" value="true"/>
</c:if>
</c:forEach>
<c:choose>
<c:when test="${found}">bg-blue-200 hover:bg-blue-300</c:when>
<c:otherwise>bg-white hover:bg-gray-100</c:otherwise>
</c:choose>
<c:if test="${mode == 'edit'}"> cursor-pointer transition-colors duration-200</c:if>
"
									<c:if test="${mode == 'edit'}">
										onclick="toggleTimeSlot(this, 'TUE', ${hour})"
									</c:if>
									data-day="TUE" data-hour="${hour}">
									<c:set var="found" value="false" />
									<c:forEach items="${facilityRT}" var="item">
										<c:if test="${item.reservationDay eq 'TUE' && item.startHour eq hour}">
											<span class="text-blue-700 font-medium">예약가능</span>
											<c:set var="found" value="true" />
										</c:if>
									</c:forEach>
									<c:if test="${!found}">
										<span class="text-gray-400">-</span>
									</c:if>
								</td>
								
								<!-- 수요일 -->
								<td
									class="border border-gray-300 p-3 text-center relative
<c:set var="found" value="false"/>
<c:forEach items="${facilityRT}" var="item">
<c:if test="${item.reservationDay eq 'WED' && item.startHour eq hour}">
<c:set var="found" value="true"/>
</c:if>
</c:forEach>
<c:choose>
<c:when test="${found}">bg-blue-200 hover:bg-blue-300</c:when>
<c:otherwise>bg-white hover:bg-gray-100</c:otherwise>
</c:choose>
<c:if test="${mode == 'edit'}"> cursor-pointer transition-colors duration-200</c:if>
"
									<c:if test="${mode == 'edit'}">
										onclick="toggleTimeSlot(this, 'WED', ${hour})"
									</c:if>
									data-day="WED" data-hour="${hour}">
									<c:set var="found" value="false" />
									<c:forEach items="${facilityRT}" var="item">
										<c:if test="${item.reservationDay eq 'WED' && item.startHour eq hour}">
											<span class="text-blue-700 font-medium">예약가능</span>
											<c:set var="found" value="true" />
										</c:if>
									</c:forEach>
									<c:if test="${!found}">
										<span class="text-gray-400">-</span>
									</c:if>
								</td>
								
								<!-- 목요일 -->
								<td
									class="border border-gray-300 p-3 text-center relative
<c:set var="found" value="false"/>
<c:forEach items="${facilityRT}" var="item">
<c:if test="${item.reservationDay eq 'THU' && item.startHour eq hour}">
<c:set var="found" value="true"/>
</c:if>
</c:forEach>
<c:choose>
<c:when test="${found}">bg-blue-200 hover:bg-blue-300</c:when>
<c:otherwise>bg-white hover:bg-gray-100</c:otherwise>
</c:choose>
<c:if test="${mode == 'edit'}"> cursor-pointer transition-colors duration-200</c:if>
"
									<c:if test="${mode == 'edit'}">
										onclick="toggleTimeSlot(this, 'THU', ${hour})"
									</c:if>
									data-day="THU" data-hour="${hour}">
									<c:set var="found" value="false" />
									<c:forEach items="${facilityRT}" var="item">
										<c:if test="${item.reservationDay eq 'THU' && item.startHour eq hour}">
											<span class="text-blue-700 font-medium">예약가능</span>
											<c:set var="found" value="true" />
										</c:if>
									</c:forEach>
									<c:if test="${!found}">
										<span class="text-gray-400">-</span>
									</c:if>
								</td>
								
								<!-- 금요일 -->
								<td
									class="border border-gray-300 p-3 text-center relative
<c:set var="found" value="false"/>
<c:forEach items="${facilityRT}" var="item">
<c:if test="${item.reservationDay eq 'FRI' && item.startHour eq hour}">
<c:set var="found" value="true"/>
</c:if>
</c:forEach>
<c:choose>
<c:when test="${found}">bg-blue-200 hover:bg-blue-300</c:when>
<c:otherwise>bg-white hover:bg-gray-100</c:otherwise>
</c:choose>
<c:if test="${mode == 'edit'}"> cursor-pointer transition-colors duration-200</c:if>
"
									<c:if test="${mode == 'edit'}">
										onclick="toggleTimeSlot(this, 'FRI', ${hour})"
									</c:if>
									data-day="FRI" data-hour="${hour}">
									<c:set var="found" value="false" />
									<c:forEach items="${facilityRT}" var="item">
										<c:if test="${item.reservationDay eq 'FRI' && item.startHour eq hour}">
											<span class="text-blue-700 font-medium">예약가능</span>
											<c:set var="found" value="true" />
										</c:if>
									</c:forEach>
									<c:if test="${!found}">
										<span class="text-gray-400">-</span>
									</c:if>
								</td>
							</tr>
						</c:forEach>
					</tbody>
				</table>
			</div>

			<!-- 범례 -->
			<div class="mt-6 flex justify-center space-x-6">
				<div class="flex items-center">
					<div class="w-4 h-4 bg-blue-200 border border-gray-300 rounded mr-2"></div>
					<span class="text-sm text-gray-600">예약 가능 시간</span>
				</div>
				<div class="flex items-center">
					<div class="w-4 h-4 bg-white border border-gray-300 rounded mr-2"></div>
					<span class="text-sm text-gray-600">예약 불가능 시간</span>
				</div>
				<c:if test="${mode == 'edit'}">
					<div class="flex items-center">
						<div class="w-4 h-4 bg-green-200 border border-gray-300 rounded mr-2"></div>
						<span class="text-sm text-gray-600">새로 추가된 시간</span>
					</div>
				</c:if>
			</div>
		</div>

		<!-- 버튼 영역 -->
		<div class="flex justify-center mt-10 space-x-4">
			<button onclick="goBack()" class="cancelButton">목록으로</button>
			
			<c:choose>
				<c:when test="${mode == 'edit'}">
<!-- 					<button onclick="cancelEdit()" class="cancelButton">취소</button> -->
					<button onclick="saveSchedule()" class="submitButton">저장</button>
				</c:when>
				<c:otherwise>
					<button onclick="insertSchedule()" class="editButton">수정</button>
				</c:otherwise>
			</c:choose>
		</div>
	</div>

	<script>
		// 변경된 시간 슬롯을 추적하는 객체
		let changedSlots = {};
		
		function insertSchedule() {
			const urlParams = new URLSearchParams(window.location.search);
			const what = urlParams.get('what');
			window.location.href = "/staff/reservationTimestamp/facility/facilityInsert.do?what=" + what;
		}
		
		function goBack() {
			window.location.href = "/staff/facility/facilityList.do";
		}
		
		function cancelEdit() {
			const urlParams = new URLSearchParams(window.location.search);
			const what = urlParams.get('what');
			window.location.href = "/staff/reservationTimestamp/facility/facility.do?what=" + what;
		}
		
		function toggleTimeSlot(cell, day, hour) {
			const key = day + '_' + hour;
			const span = cell.querySelector('span');
			
			if (span.textContent === '예약가능') {
				// 예약가능 -> 예약불가능으로 변경
				span.textContent = '-';
				span.className = 'text-gray-400';
				cell.className = cell.className.replace(/bg-blue-200|bg-green-200/, 'bg-white');
				cell.className = cell.className.replace(/hover:bg-blue-300/, 'hover:bg-gray-100');
				changedSlots[key] = 'delete';
			} else {
				// 예약불가능 -> 예약가능으로 변경
				span.textContent = '예약가능';
				span.className = 'text-blue-700 font-medium';
				cell.className = cell.className.replace(/bg-white/, 'bg-green-200');
				cell.className = cell.className.replace(/hover:bg-gray-100/, 'hover:bg-green-300');
				changedSlots[key] = 'add';
			}
		}
		
		function saveSchedule() {
			  const activeSlots = [];

			  // 모든 셀을 확인
			  document.querySelectorAll("td[data-day][data-hour]").forEach(cell => {
			    const day = cell.dataset.day;
			    const hour = parseInt(cell.dataset.hour);
			    const classList = cell.className;

			    // 배경색이 흰색이 아닌 경우만 activeSlots에 추가
			    if (!classList.includes('bg-white')) {
			      activeSlots.push({ day, hour });
			    }
			  });

			  const urlParams = new URLSearchParams(window.location.search);
			  const what = urlParams.get('what');

			  const formData = new FormData();
			  formData.append('what', what);
			  formData.append('timeSlots', JSON.stringify(activeSlots));

			  fetch('/staff/reservationTimestamp/facility/facilityUpdateProcess.do', {
			    method: 'POST',
			    body: formData
			  })
			    .then(response => response.json())
			    .then(data => {
			      if (data.success) {
			        alert('예약 시간 설정이 저장되었습니다!');
			        window.location.href = "/staff/reservationTimestamp/facility/facility.do?what=" + what;
			      } else {
			        alert('저장 중 오류가 발생했습니다.');
			      }
			    })
			    .catch(error => {
			      console.error('Error:', error);
			      alert('저장 중 오류가 발생했습니다.');
			    });
			}

	</script>

</body>
</html>