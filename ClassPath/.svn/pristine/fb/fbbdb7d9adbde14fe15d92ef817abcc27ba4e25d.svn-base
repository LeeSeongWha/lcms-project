package kr.or.ddit.common.controller;

import java.util.Date;
import java.util.Map;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.core.Authentication;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.GetMapping;
import kr.or.ddit.pfcp.common.vo.UserVO;
import kr.or.ddit.pfcp.staff.schedule.service.StaffScheduleService;
import kr.or.ddit.pfcp.student.eclass.assignement.service.AssignSubmissionService;
import kr.or.ddit.pfcp.student.lecture.enroll.service.LectureEnrService;
import kr.or.ddit.pfcp.student.notice.service.StudentNoticeService;
import kr.or.ddit.security.auth.UserVOWrapper;

@Controller
public class IndexController {
  
  @Autowired
  AssignSubmissionService assignSubmissionService;
  
  @Autowired
  LectureEnrService lectureEnrService;
  
  @Autowired
  StaffScheduleService staffScheduleService;
  
  @Autowired
  StudentNoticeService studentNoticeService;
  
  @GetMapping("/")
  public String index(
      Model model,
      Authentication authentication
      ) {
    UserVO user = null;
    if (authentication != null && authentication.getPrincipal() instanceof UserVOWrapper wrapper) {
      user = wrapper.getRealUser(); // getUserVO는 UserVOWrapper에 구현된 메서드라고 가정
      model.addAttribute("student", user);
  } else {
    return "redirect:/login";
  }
    
    model.addAttribute("currentSemester", "2025-01학기");
    model.addAttribute("currentDate", new Date());
    model.addAttribute("assignmentCount", assignSubmissionService.readRequiredAssignmentCount(user.getUserNo()));
    
    model.addAttribute("currentCourses", lectureEnrService.getMyEnrollList(user.getUserNo()));
    model.addAttribute("todaySchedule", staffScheduleService.getScheduleList(Map.of("userNo", user.getUserNo())));
    
    model.addAttribute("recentNotices", studentNoticeService.readNoticeList());
    return "index";
  }
}
