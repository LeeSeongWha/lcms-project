<%@ page contentType="text/html; charset=UTF-8"%>
<%@ taglib prefix="c" uri="jakarta.tags.core"%>
<%@ taglib prefix="form" uri="http://www.springframework.org/tags/form"%>
<!DOCTYPE html>
<html>
<head>
<title>ë¹„êµê³¼ í”„ë¡œê·¸ë¨ ê´€ë¦¬</title>
<link rel="stylesheet" href="/dist/assets/css/bodyFormat.css" />
<link rel="stylesheet" href="/dist/assets/css/attendclass.css">
<link rel="stylesheet"
	href="/dist/assets/css/staff/requestCollection.css">
<link rel="stylesheet" href="/dist/assets/css/staff/programChart.css">
<script>
document.addEventListener("DOMContentLoaded", function () {
  document.querySelectorAll('[data-tab]').forEach(tab => {
    tab.addEventListener('click', function () {
      const selected = this.dataset.tab;

      // âœ… ëª¨ë“  íƒ­ ë²„íŠ¼ì—ì„œ tabButtonActive ì œê±°
      document.querySelectorAll('.tabButton').forEach(btn => {
        btn.classList.remove('tabButtonActive');
      });

      // âœ… í˜„ì¬ í´ë¦­ëœ íƒ­ì—ë§Œ tabButtonActive ì¶”ê°€
      this.classList.add('tabButtonActive');

      // âœ… íƒ­ ì½˜í…ì¸  ë³´ì´ê¸° ì²˜ë¦¬
      document.querySelectorAll('[data-tab-content]').forEach(div => {
        div.style.display = div.dataset.tabContent === selected ? 'block' : 'none';
      });
    });
  });

  const container = document.getElementById("feedbackListContainer");
  if (!container) return;

  // í”¼ë“œë°± ëª©ë¡ ë Œë”ë§
  fetch("/staff/program/feedbackList")
    .then(res => res.json())
    .then(data => {
      allFeedback = data.filter(fb => {
        const score = parseInt(fb.feedbackAccount);
        return !isNaN(score) && score >= 1 && score <= 5;
      });

      renderTypeTabs(allFeedback);
      renderFeedbackList(allFeedback); // ì´ˆê¸° ì „ì²´ ì¶œë ¥
      renderSatisfactionChart(allFeedback);
    });

  // ìœ í˜•ë³„ í‰ê·  ì ìˆ˜ & ì‘ë‹µì ìˆ˜
  fetch("/staff/program/satisfaction/byType")
    .then(res => res.json())
    .then(data => {
      const avg = (
        data.reduce((sum, item) => sum + item.AVG_SCORE, 0) / data.length
      ).toFixed(1);
      document.getElementById("totalScoreBox").innerText = `ì „ì²´ í‰ê·  ë§Œì¡±ë„: \${avg} / 5.0`;
      document.getElementById("totalAppPer").innerText = `í”„ë¡œê·¸ë¨ ì„¤ë¬¸ ë¹„ìœ¨`;

      const barGroup = document.getElementById("satisfactionBarGroup");
      const total = data.reduce((sum, item) => sum + item.RESPONDENT_COUNT, 0);

      const labelMap = {
        PRG_GENERAL: "ì¼ë°˜",
        PRG_CERT: "ìê²©ì¦",
        PRG_VOLUNTEER: "ë´‰ì‚¬"
      };

      const colorMap = {
        PRG_GENERAL: "#4CAF50",
        PRG_CERT: "#2196F3",
        PRG_VOLUNTEER: "#FFC107"
      };

      barGroup.innerHTML = data.map(item => {
        const percent = total ? Math.round((item.RESPONDENT_COUNT / total) * 100) : 0;
        const label = labelMap[item.TYPE_CODE] || item.TYPE_CODE;
        const color = colorMap[item.TYPE_CODE] || "#ccc";
        return `
          <div class="bar-item">
            <div class="bar-label">\${label}</div>
            <div class="bar-outer">
              <div class="bar-fill" style="width: \${percent}%; background-color: \${color};"></div>
            </div>
            <div class="bar-percent">\${percent}%</div>
          </div>
        `;
      }).join('');
    });
});

// ë§Œì¡±ë„ ì°¨íŠ¸ ë Œë”ë§
function renderSatisfactionChart(data) {
  const dist = {
    "ë§¤ìš° ë§Œì¡±": 0, "ë§Œì¡±": 0, "ë³´í†µ": 0, "ë¶ˆë§Œì¡±": 0, "ë§¤ìš° ë¶ˆë§Œì¡±": 0
  };

  let total = 0, totalScore = 0;

  data.forEach(fb => {
    const score = parseInt(fb.feedbackAccount);
    if (isNaN(score)) return;
    total++; totalScore += score;
    if (score === 5) dist["ë§¤ìš° ë§Œì¡±"]++;
    else if (score === 4) dist["ë§Œì¡±"]++;
    else if (score === 3) dist["ë³´í†µ"]++;
    else if (score === 2) dist["ë¶ˆë§Œì¡±"]++;
    else if (score === 1) dist["ë§¤ìš° ë¶ˆë§Œì¡±"]++;
  });

  const avg = total ? (totalScore / total).toFixed(1) : "0.0";
  document.getElementById("totalScoreBox").innerText = `ì „ì²´ í‰ê·  ë§Œì¡±ë„: \${avg} / 5.0`;

  const colorMap = {
    "ë§¤ìš° ë§Œì¡±": "#4CAF50",
    "ë§Œì¡±": "#2196F3",
    "ë³´í†µ": "#FFC107",
    "ë¶ˆë§Œì¡±": "#FF5722",
    "ë§¤ìš° ë¶ˆë§Œì¡±": "#f44336"
  };

  const group = document.getElementById("totalScoreBox");
  group.innerHTML = Object.entries(dist).map(([label, count]) => {
    const percent = total ? Math.round((count / total) * 100) : 0;
    return `
      <div class="s-bar">
        <strong>\${label}</strong> <span>\${percent}%</span>
        <div class="bar-outer">
          <div class="bar-fill" style="width: \${percent}%; background-color: \${colorMap[label]}"></div>
        </div>
      </div>
    `;
  }).join('');
}

function renderTypeTabs(data) {
  const typeTabMenu = document.getElementById("typeTabMenu");
  const typeSet = new Set(data.map(fb => fb.program?.typeCode).filter(Boolean));
  const typeNameMap = {
    PRG_GENERAL: "ì¼ë°˜", PRG_CERT: "ìê²©ì¦", PRG_VOLUNTEER: "ë´‰ì‚¬"
  };

  let html = "", firstType = null;
  typeSet.forEach((type, idx) => {
    const label = typeNameMap[type] || type;
    if (idx === 0) firstType = type;
    html += `<button class="tab-btn\${idx === 0 ? ' active' : ''}" data-type="\${type}">\${label}</button>`;
  });
  typeTabMenu.innerHTML = html;

  document.querySelectorAll(".tab-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
      btn.classList.add("active");

      const type = btn.dataset.type;
      const filtered = allFeedback.filter(fb => fb.program?.typeCode === type);
      renderFeedbackList(filtered);
    });
  });

  if (firstType) {
    const firstFiltered = allFeedback.filter(fb => fb.program?.typeCode === firstType);
    renderFeedbackList(firstFiltered);
  }
}

function renderFeedbackList(data) {
  const container = document.getElementById("feedbackListContainer");
  container.innerHTML = data.map(fb => `
    <div class="feedback-card">
      <div class="program-title">\${fb.program?.programTitle ?? 'í”„ë¡œê·¸ë¨ëª… ì—†ìŒ'}</div>
      <div class="feedback-meta">
        <span class="feedback-name">\${fb.feedbackAccount}</span>
        <span class="feedback-stars">\${renderStars(parseInt(fb.feedbackAccount))}</span>
      </div>
      <div class="feedback-comment">\${fb.feedbackComment}</div>
      <div class="feedback-date">\${fb.submitDate}</div>
    </div>
  `).join('');
}

function renderStars(score) {
  const fullStars = Math.min(score, 5);
  return 'â­'.repeat(fullStars) + 'â˜†'.repeat(5 - fullStars);
}

function goToApplyPage(programNo) {
  location.href = '/staff/program/apply/' + programNo;
}

function goToDetail(programNo) {
  location.href = '/staff/program/edit/' + programNo;
}

function deleteProgram(programNo) {
  if (!confirm("ì •ë§ ì´ í”„ë¡œê·¸ë¨ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
  fetch('/staff/program/delete/' + programNo, {
    method: 'Delete'
  })
    .then(res => {
      if (res.ok) {
        alert("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
        location.reload();
      } else {
        alert("ì‚­ì œ ì‹¤íŒ¨");
      }
    })
    .catch(() => alert("ì„œë²„ ì˜¤ë¥˜"));
}
</script>


</head>
<body>
	<div class="container">
		<!-- í˜ì´ì§€ íƒ€ì´í‹€ -->
		<h1 class="pageTitle">
			<i class="fas fa-layer-group"></i> ë¹„êµê³¼ í”„ë¡œê·¸ë¨ ê´€ë¦¬ ì‹œìŠ¤í…œ
		</h1>

		<%-- ë§ˆì§€ë§‰ ê°±ì‹  ì‹œê° í‘œì‹œ (í•„ìš” ì‹œ ì£¼ì„ í•´ì œ) --
    <p class="stat-update-time">
        ë§ˆì§€ë§‰ ê°±ì‹  ì‹œê°: <strong>${stat.regDate}</strong>
    </p>
    --%>

		<!-- í†µê³„ ìš”ì•½ ì¹´ë“œ -->
		<div class="stats-grid">
			<div class="stat-card">
				<div class="stat-number">${liveStat.totalPrograms}</div>
				<div class="stat-label">ì „ì²´ í”„ë¡œê·¸ë¨</div>
			</div>
			<div class="stat-card"
				style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
				<div class="stat-number">${liveStat.totalApplicants}</div>
				<div class="stat-label">ì´ ì°¸ì—¬ì ìˆ˜</div>
			</div>
			<div class="stat-card"
				style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
				<div class="stat-number">${liveStat.monthlyApply}</div>
				<div class="stat-label">ì´ë²ˆ ë‹¬ ì‹ ì²­ ìˆ˜</div>
			</div>
			<div class="stat-card"
				style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
				<div class="stat-number">${liveStat.completeRate}%</div>
				<div class="stat-label">ì™„ë£Œìœ¨</div>
			</div>
		</div>
	</div>


	<div class="tabContainer">
		<button data-tab="program"
			class="tabButton">
			<i class="fas fa-tasks"></i> í”„ë¡œê·¸ë¨ ê´€ë¦¬
		</button>
		<button data-tab="apply"
			class="tabButton">
			<i class="fas fa-user-check"></i> ì‹ ì²­ ê´€ë¦¬
		</button>
		<%-- 
    <button data-tab="followup" class="tabButton ${tab eq 'followup' ? 'tabButtonActive' : ''}">
        <i class="fas fa-clipboard-list"></i> ì‚¬í›„ ê´€ë¦¬
    </button> 
    --%>
		<button data-tab="statistics"
			class="tabButton">
			<i class="fas fa-chart-bar"></i> í†µê³„ ë¶„ì„
		</button>
		<button data-tab="survey"
			class="tabButton">
			<i class="fas fa-poll"></i> ì„¤ë¬¸ ê´€ë¦¬
		</button>
	</div>



	<!--ë¹„êµê³¼ í”„ë¡œê·¸ë¨ ê´€ë¦¬ íƒ­  -->
	<div class="tab-content" data-tab-content="program"
		style="display: block;">
		<h3>ë¹„êµê³¼ í”„ë¡œê·¸ë¨ ê´€ë¦¬</h3>
		<div class="add-button">

			<button type="button" class="btn-add"
				onclick="location.href='/staff/program/form'">ìƒˆ í”„ë¡œê·¸ë¨ ì¶”ê°€</button>
		</div>
		<table>
			<thead>
				<tr>
					<th>í”„ë¡œê·¸ë¨ëª…</th>
					<th>ê¸°ê°„</th>
					<th>ìƒíƒœ</th>
					<th>ìœ í˜•</th>
					<th>ì •ì›</th>
					<th>ì¥ì†Œ</th>
					<th>ê´€ë¦¬</th>
				</tr>
			</thead>
			<tbody>
				<c:forEach var="p" items="${programList}">
					<tr class="ahover">
						<td onclick="goToDetail('${p.programNo}')">${p.programTitle}</td>
						<td onclick="goToDetail('${p.programNo}')">${p.startDate}~${p.endDate}</td>
						<td onclick="goToDetail('${p.programNo}')"><c:choose>
								<c:when test="${p.programActive eq 'N'}">
                              ëª¨ì§‘ì¤‘
                           </c:when>
								<c:when test="${p.programActive eq 'Y'}">
                              ì§„í–‰ì¤‘
                           </c:when>
								<c:when test="${p.programActive eq 'C'}">
                              ì™„ë£Œ
                           </c:when>
							</c:choose></td>
						<td onclick="goToDetail('${p.programNo}')">${p.type.typeName }</td>
						<td onclick="goToDetail('${p.programNo}')">${p.programCapacity }</td>
						<td onclick="goToDetail('${p.programNo}')">${p.place }</td>
						<td>
							<button onclick="deleteProgram('${p.programNo}')" title="ì‚­ì œ"
								style="background: none; border: none; cursor: pointer;">
								ğŸ—‘</button>
						</td>
					</tr>
				</c:forEach>
			</tbody>
		</table>
	</div>


	<div class="tab-content" data-tab-content="apply"
		style="display: none;">
		<div class="section">
			<div class="sectionHeaderLine">
				<div>
					<div class="sectionHeaderTitle">ë¹„êµê³¼ í”„ë¡œê·¸ë¨ ì‹ ì²­ ê´€ë¦¬</div>
				</div>
			</div>

			<div class="lecture-list-container">
				<c:set var="displayedCount" value="0" />
				<c:choose>
					<c:when test="${not empty openProgramList}">
						<c:forEach var="p" items="${openProgramList}">
							<c:url value="/staff/program/apply/${p.programNo}"
								var="detailURL" />
							<a href="${detailURL}" class="lecture-item-link">
								<div class="lecture-item-content">
									<div class="lecture-info-group">
										<div class="lecture-icon-wrapper">
											<svg xmlns="http://www.w3.org/2000/svg" class="lecture-icon"
												fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                 <path stroke-linecap="round"
													stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                              </svg>
										</div>
										<div>
											<span class="lecture-name">${p.programTitle}</span>
											<p class="lecture-details">
												ãƒ» í”„ë¡œê·¸ë¨ ë²ˆí˜¸: ${p.programNo}<br> ãƒ» ìœ í˜•: ${p.type.typeName}<br>
												ãƒ» ê¸°ê°„: ${p.startDate} ~ ${p.endDate}<br> ãƒ» ì •ì›:
												${p.programCapacity}ëª…
											</p>
										</div>
									</div>
								</div>
							</a>
							<c:set var="displayedCount" value="${displayedCount + 1}" />
						</c:forEach>
					</c:when>
				</c:choose>

				<c:if test="${displayedCount == 0}">
					<div class="no-lecture-message">ëª¨ì§‘ ì¤‘ì¸ ë¹„êµê³¼ í”„ë¡œê·¸ë¨ì´ ì—†ìŠµë‹ˆë‹¤.</div>
				</c:if>
			</div>
		</div>
	</div>

	<div class="tab-content" data-tab-content="statistics"
		style="display: none;">

		<!-- ê¸°ì¡´ í†µê³„ ê°œìš” + donut ì°¨íŠ¸ë¥¼ í•˜ë‚˜ì˜ í–‰ìœ¼ë¡œ ê°ì‹¸ê¸° -->
		<div class="chart-row">
			<div class="chart-box">
				<h4 class="chart-title">ğŸ“Š í†µê³„ ê°œìš”</h4>
				<canvas id="programStatChart" width="300" height="250"></canvas>
				<p class="chart-desc">
					ì „ì²´ ì´ìˆ˜ìœ¨: <strong>${stat.completeRate}%</strong>
				</p>
			</div>

			<div class="chart-box">
				<h4 class="chart-title">ğŸ“Š ìœ í˜•ë³„ ì‹ ì²­ì í†µê³„</h4>
				<canvas id="donutChart" width="300" height="250"></canvas>
				<p class="chart-desc">ìµœê·¼ 30ì¼ ê¸°ì¤€</p>
			</div>
		</div>

		<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
		<script>
             const barCtx = document.getElementById('programStatChart').getContext('2d');
         
             new Chart(barCtx, {
               type: 'bar',
               data: {
                 labels: ['ì „ì²´ í”„ë¡œê·¸ë¨ ìˆ˜', 'ì „ì²´ ì‹ ì²­ì ìˆ˜', 'ë‹¹ì›” ì‹ ì²­ì ìˆ˜'],
                 datasets: [{
                   label: 'í†µê³„ ìˆ˜ì¹˜',
                   data: [${stat.totalPrograms}, ${stat.totalApplicants}, ${stat.monthlyApply}],
                   backgroundColor: ['#4e79a7', '#f28e2b', '#e15759'],
                   borderColor: ['#4e79a7', '#f28e2b', '#e15759'],
                   borderWidth: 1,
                   borderRadius: 5
                 }]
               },
               options: {
                 responsive: true,
                 plugins: {
                   legend: {
                     display: true,
                     position: 'bottom',
                     labels: {
                       font: { size: 12 },
                       color: '#333'
                     }
                   },
                   title: {
                     display: false
                   },
                   tooltip: {
                     backgroundColor: '#333',
                     titleFont: { weight: 'bold' },
                     bodyFont: { size: 13 },
                     padding: 10
                   }
                 },
                 scales: {
                   y: {
                     beginAtZero: true,
                     suggestedMax: Math.ceil(Math.max(${stat.totalPrograms}, ${stat.totalApplicants}, ${stat.monthlyApply}) * 1.1), 
                     grid: {
                       color: '#eee'
                     },
                     ticks: {
                       stepSize: 1,
                       font: { size: 12 }
                     }
                   },
                   x: {
                     ticks: {
                       font: { size: 12 }
                     }
                   }
                 }
               }
             });
           </script>


		<script>
	           fetch("/staff/program/donut/data")
	             .then(response => response.json())
	             .then(data => {
	            	 
	            	 
	           		const typeNameMap = {
	            		PRG_CERT: "ìê²©ì¦ í”„ë¡œê·¸ë¨",
	            		PRG_VOLUNTEER: "ë´‰ì‚¬ í”„ë¡œê·¸ë¨",
	            		PRG_GENERAL: "ì¼ë°˜ í”„ë¡œê·¸ë¨"
	            	};
	
	           	 const labels = data.map(d => typeNameMap[d.typeCode] || d.typeCode);
	               const values = data.map(d => d.applyCount);
	         
	               const ctx = document.getElementById('donutChart').getContext('2d');
	               new Chart(ctx, {
	                 type: 'doughnut',
	                 data: {
	                   labels: labels,
	                   datasets: [{
	                     label: 'ì‹ ì²­ì ìˆ˜',
	                     data: values,
	                     backgroundColor: [
	                       '#4e79a7', '#f28e2b', '#e15759', '#76b7b2',
	                       '#59a14f', '#edc948', '#b07aa1', '#ff9da7'
	                     ],
	                     borderWidth: 1
	                   }]
	                 },
	                 options: {
	                   responsive: true,
	                   plugins: {
	                     legend: {
	                       position: 'bottom'
	                     },
	                     title: {
	                       display: false
	                     }
	                   }
	                 }
	               });
	             });
	      </script>



	</div>
	<div class="tab-content" data-tab-content="survey"
		style="display: none;">
		<div class="survey-summary-grid">

			<!-- ì¢Œì¸¡: í”¼ë“œë°± ì¹´ë“œ -->
			<div class="feedback-card-wrapper">
				<h4>ğŸ’¬ í”¼ë“œë°±</h4>

				<!-- âœ… íƒ­ ë©”ë‰´ ë”°ë¡œ -->
				<div id="typeTabMenu" class="tab-menu-wrapper"
					style="margin-bottom: 1rem;"></div>

				<!-- âœ… í”¼ë“œë°± ë¦¬ìŠ¤íŠ¸ ì»¨í…Œì´ë„ˆ -->
				<div id="feedbackListContainer" class="feedback-list"></div>
			</div>

			<!-- ìš°ì¸¡: ë§Œì¡±ë„ í†µê³„ -->
			<div class="satisfaction-chart-wrapper">
				<h4>ğŸ“‹ ë§Œì¡±ë„ ì¡°ì‚¬</h4>

				<div class="total-score" id="totalAppPer"></div>
				<div id="satisfactionBarGroup" class="satisfaction-bar-group"></div>
				<div class="total-score" id="totalScoreBox"></div>
			</div>

		</div>

	</div>

	</div>
</body>
</html>



