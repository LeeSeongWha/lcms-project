<%@ page contentType="text/html;charset=UTF-8" language="java"%>
<%@ taglib uri="jakarta.tags.core" prefix="c"%>
<%@ taglib uri="http://www.springframework.org/tags/form" prefix="form"%>
<!DOCTYPE html>
<html>
<head>
<title>ì¼ì • ê´€ë¦¬</title>

<link rel="stylesheet" href="/dist/assets/css/bodyFormat.css">
<link
	href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.5/main.min.css"
	rel="stylesheet" />
<script
	src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.5/main.min.js"></script>
<script
	src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.5/locales-all.min.js"></script>

<style>
#calendar {
	max-width: 900px;
	margin: 50px auto;
}

.error {
	color: red;
	font-size: 0.9em;
}

#schedulePopup {
	display: none;
	position: fixed;
	top: 20%;
	left: 50%;
	transform: translateX(-50%);
	background: #fff;
	padding: 20px;
	border: 2px solid #333;
	box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
	z-index: 9999;
	min-width: 300px;
	border-radius: 8px;
}
</style>
</head>
<body>
	<h2 style="text-align: center;">ğŸ“… êµì§ì› ì¼ì • ê´€ë¦¬</h2>

	<div id="calendar"></div>

	<script>
    document.addEventListener('DOMContentLoaded', function () {
      var calendarEl = document.getElementById('calendar');
      var calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        locale: 'ko',
        headerToolbar: {
          left: 'prev,next today',
          center: 'title',
          right: 'dayGridMonth'
        },
        events: '/staff/schedule/list',
        eventDataTransform: function(e){
        	//console.log(e)
        	return {
        		id: e.scheduleNo,
        		title: e.scheduleTitle,
        		start: e.startDate,
        	    end: e.endDate,
        	    extendeProps: {
        	    	 scheduleDesp: e.scheduleDesp,
        	         type: e.type
        		}
        	};
     	 },
      
        
        eventClick: function (info) {
          const data = info.event.extendedProps;
          const popup = document.getElementById("schedulePopup");
          console.log("info>>", info)
          console.log("data -->", data)
          const content = `
        	  <strong>ğŸ“Œ ì œëª©:</strong> \${info.event.title}<br>
        	  <strong>ğŸ“… ì‹œì‘ì¼:</strong> \${data.startDate}<br>
        	  <strong>ğŸ“… ì¢…ë£Œì¼:</strong> \${data.endDate}<br>
        	  <strong>ğŸ“‚ ì¼ì • ìœ í˜•:</strong> \${(data.type && data.type.scheduleTypeName) ? data.type.scheduleTypeName : 'ì—†ìŒ'}<br>
        	  <strong>ğŸ“ ì„¤ëª…:</strong> \${data.scheduleDesp || 'ì—†ìŒ'}<br>
        	`;
          document.getElementById("popupContent").innerHTML = content;

          // ìˆ˜ì • ë²„íŠ¼
          document.getElementById("editBtn").onclick = function () {
            fetch(`/staff/schedule/\${info.event.id}`)
              .then(res => res.json())
              .then(data => {
            	  console.log("resjson", data)
                document.querySelector("#scheduleNo").value = data.scheduleNo;
                document.querySelector("#scheduleTitle").value = data.scheduleTitle;
                document.querySelector("#startDate").value = data.startDate;
                document.querySelector("#endDate").value = data.endDate;
                document.querySelector("#scheduleType").value = data.scheduleType;
                document.querySelector("#scheduleDesp").value = data.scheduleDesp;
                document.querySelector("#formMode").value = "update";
                document.querySelector("#submitBtn").textContent = "ìˆ˜ì •";
                document.querySelector("#resetBtn").style.display = "inline-block";
                document.querySelector("#regititle").innerHTML  = "ì¼ì • ìˆ˜ì •";
                closePopup();
              });
          };
          // ğŸ“Œ ë“±ë¡/ìˆ˜ì • í¼ ì´ˆê¸°í™” ë²„íŠ¼ ì´ë²¤íŠ¸
          document.querySelector("#resetBtn").addEventListener("click", function () {
            document.querySelector("#scheduleNo").value = "";
            document.querySelector("#scheduleTitle").value = "";
            document.querySelector("#startDate").value = "";
            document.querySelector("#endDate").value = "";
            document.querySelector("#scheduleType").value = "";
            document.querySelector("#scheduleDesp").value = "";
            document.querySelector("#formMode").value = "insert";
            document.querySelector("#submitBtn").textContent = "ì €ì¥";
            document.querySelector("#resetBtn").style.display = "none";
            document.querySelector("#regititle").innerHTML  = "ì¼ì • ë“±ë¡";
          });

          // ì‚­ì œ ë²„íŠ¼
          document.getElementById("deleteBtn").onclick = function () {
            if (confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
              fetch(`/staff/schedule/\${info.event.id}`, {
                method: 'DELETE'
              })
              .then(res => res.json())
              .then(result => {
                if (result.result === 1) {
                  alert("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                  calendar.refetchEvents(); // ì‚­ì œ í›„ ìƒˆë¡œê³ ì¹¨
                  closePopup();
                } else {
                  alert("ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                }
              });
            }
          };

          popup.style.display = "block";
        }
      });

      calendar.render();
    });

    function closePopup() {
      document.getElementById("schedulePopup").style.display = "none";
    }
  </script>

	<h3 style="text-align: center;" id="regititle">ğŸ“¥ ì¼ì • ë“±ë¡</h3>
	<button class="btn btn-secondary" type="button" id="resetBtn"
		style="display: none;">ë“±ë¡ìœ¼ë¡œ</button>

	<form:form modelAttribute="scheduleVO" action="/staff/schedule/save"
		method="post" style="width:900px; margin: 0 auto;">
		<form:hidden path="scheduleNo" id="scheduleNo" />
		<input type="hidden" name="formMode" id="formMode" value="insert" />

		<fieldset style="padding: 20px; border: 1px solid #ccc;">
			<table style="width: 100%; border-collapse: collapse;">
				<tr>
					<td><label for="scheduleTitle">ì¼ì • ì œëª©</label></td>
					<td><form:input path="scheduleTitle" id="scheduleTitle" /> <form:errors
							path="scheduleTitle" cssClass="error" /></td>
				</tr>
				<tr>
					<td><label for="startDate">ì‹œì‘ì¼</label></td>
					<td><form:input path="startDate" id="startDate" type="date" />
						<form:errors path="startDate" cssClass="error" /></td>
				</tr>
				<tr>
					<td><label for="endDate">ì¢…ë£Œì¼</label></td>
					<td><form:input path="endDate" id="endDate" type="date" /> <form:errors
							path="endDate" cssClass="error" /></td>
				</tr>
				<tr>
					<td><label for="scheduleType">ì¼ì • ìœ í˜•</label></td>
					<td><form:select path="type.scheduleTypeNo" id="scheduleType"
							items="${scheduleTypes}" itemValue="scheduleTypeNo"
							itemLabel="scheduleTypeName" /> <form:errors
							path="type.scheduleTypeNo" cssClass="error" /></td>
				</tr>
				<tr>
					<td><label for="scheduleDesp">ì¼ì • ì„¤ëª…</label></td>
					<td><form:textarea path="scheduleDesp" id="scheduleDesp"
							rows="3" cols="40" /> <form:errors path="scheduleDesp"
							cssClass="error" /></td>
				</tr>
			</table>
			<div style="text-align: right; margin-top: 15px;">
				<button class="btn btn-primary" type="submit" id="submitBtn">ì €ì¥</button>
			</div>
		</fieldset>
	</form:form>

	<!-- ğŸ“‹ ì¼ì • ìƒì„¸ íŒì—… ëª¨ë‹¬ -->
	<div id="schedulePopup">
		<div id="popupContent" style="line-height: 1.6;"></div>
		<div style="text-align: right; margin-top: 12px;">
			<button id="editBtn" style="margin-right: 6px;">âœï¸ ìˆ˜ì •</button>
			<button id="deleteBtn" style="margin-right: 6px;">ğŸ—‘ï¸ ì‚­ì œ</button>
			<button onclick="closePopup()">ë‹«ê¸°</button>
		</div>
	</div>
</body>
</html>
