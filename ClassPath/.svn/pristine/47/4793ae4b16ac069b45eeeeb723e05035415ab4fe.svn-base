package kr.or.ddit.pfcp.staff.lecturemanage.attendance.controller;

import java.util.List;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.validation.BindingResult;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.ModelAttribute;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.servlet.mvc.support.RedirectAttributes;

import kr.or.ddit.pfcp.common.vo.AttendanceVO;
import kr.or.ddit.pfcp.staff.lecturemanage.attendance.service.AttendanceService;
import kr.or.ddit.validate.utils.ErrorsUtils;
import lombok.extern.slf4j.Slf4j;

/**
 * @author YSM
 * @since 250628
 */
@Slf4j
@Controller
@RequestMapping("/staff/lecturemanage/attendance")
public class AttendanceController {
	
	@Autowired
	private AttendanceService service;
	
	static final String MODELNAME = "attendance";
	
	@ModelAttribute(MODELNAME)
	public AttendanceVO attendance() {
		return new AttendanceVO();
	}
	
	@Autowired
	private ErrorsUtils errorsUtils;
	
	//=========================================================================================
	
	
	/**
	 * 출석 목록 전체 조회 (수업 별 학생 별 조회)
	 * @return
	 */
	@GetMapping("attendanceList.do")
	public String attendanceListUI(
			@RequestParam String enrNo,
			@RequestParam String userNo,
			Model model) {
		
		List<AttendanceVO> attendance = service.readAttendanceList(enrNo, userNo);
		model.addAttribute("attendance", attendance);
		
		log.info("enrNo" + enrNo);
		log.info("userNo" + userNo);
		
		
		if (!attendance.isEmpty()) {
		    model.addAttribute("lectureName", attendance.get(0).getLectureReq().getLecName());
		    model.addAttribute("userName", attendance.get(0).getUser().getUserName());
		}
		
		return "pfcp/staff/lecturemanage/attendance/attendanceList";
	}
	
	/**
	 * 출석 목록 수정 사항 저장
	 * @return
	 */
	@PostMapping("attendanceUpdateProcess.do")
	public String attendanceUpdateUI(
		String what,
		@ModelAttribute(MODELNAME) List<AttendanceVO> attendanceList,
		BindingResult errors,
		RedirectAttributes redirectAttributes
	) {
		String lvn;
		
		
		if(!errors.hasErrors()) {
			service.modifyAttendance(attendanceList);
			lvn = "redirect:/staff/lecturemanage/lecture/lectureList.do";
		}else {
//			redirectAttributes.addFlashAttribute(MODELNAME, student);
//			MultiValueMap<String, String> customErrors = errorsUtils.errorsToMap(errors);
//			redirectAttributes.addFlashAttribute("errors", customErrors);
			lvn= "redirect:/staff/studentmanage/studentUpdate.do?what="+what;
		}
		
		
		return lvn;
		
//		return "pfcp/staff/lecturemanage/attendance/attendanceDetail";
	}
}


























