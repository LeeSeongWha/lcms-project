<%@ page contentType="text/html;charset=UTF-8" language="java"%>
<%@ taglib uri="jakarta.tags.core" prefix="c"%>
<%@ taglib uri="http://www.springframework.org/tags/form" prefix="form"%>

<title>ìº˜ë¦°ë”</title>
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.5/main.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.5/main.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.5/locales-all.min.js"></script>
<script src="/js/app/pfcp/common/shortcut.js"></script>

<!-- <link rel="stylesheet" href="/dist/assets/css/bodyFormat.css"> -->
<link rel="stylesheet" href="/dist/assets/css/schedule/student.css">



<div class="calendar-container">
	<!-- í˜ì´ì§€ ì œëª© -->
	<h1 class="page-title">- CALENDAR -</h1>

	<!-- í•„í„° ì„¹ì…˜ -->
	<div class="filter-section">
		<div class="filter-row">
			<div class="filter-group">
				<label for="filterType">ì¼ì • ìœ í˜•</label> <select id="filterType"
					class="form-control">
					<option value="">ì „ì²´</option>
					<c:forEach var="type" items="${scheduleTypes}">
						<option value="${type.scheduleTypeNo}">${type.scheduleTypeName}</option>
					</c:forEach>
				</select>
			</div>
			<div class="filter-group">
				<label for="filterStart">ì‹œì‘ì¼</label> <input type="date"
					id="filterStart" class="form-control" />
			</div>
			<div class="filter-group">
				<label for="filterEnd">ì¢…ë£Œì¼</label> <input type="date" id="filterEnd"
					class="form-control" />
			</div>
			<div class="filter-buttons">
				<button type="button" id="filterBtn" class="btn btn-outline-primary">ğŸ”
					ê²€ìƒ‰</button>
				<button type="button" id="resetFilterBtn"
					class="btn btn-outline-secondary">ğŸ”„ ì´ˆê¸°í™”</button>
			</div>
		</div>
	</div>

	<!-- ì¼ì • ë“±ë¡ ë²„íŠ¼ -->
	<div class="add-schedule-btn">
		<button type="button" id="addScheduleBtn" class="btn btn-primary">+
			ìƒˆ ì¼ì • ë“±ë¡</button>
	</div>

	<!-- ë©”ì¸ ë ˆì´ì•„ì›ƒ -->
	<div class="main-layout">
		<!-- ìº˜ë¦°ë” ì˜ì—­ -->
		<div class="calendar-area">
			<div id="calendar"></div>
		</div>
	</div>
</div>

<!-- ëª¨ë‹¬ ì˜¤ë²„ë ˆì´ -->
<div id="modalOverlay" class="modal-overlay"></div>

<!-- ì¼ì • ë“±ë¡ ëª¨ë‹¬ -->
<div id="scheduleModal">
	<div class="modal-header">
		<h3 id="modalTitle">ì¼ì • ë“±ë¡</h3>
	</div>
	<div class="modal-body">
		<form:form id="scheduleForm" method="post" action="/schedule.do/save"
			modelAttribute="scheduleVO">
			<input type="hidden" id="scheduleNo" name="scheduleNo" />
			<input type="hidden" id="formMode" name="formMode" value="insert" />

			<c:if test="${userRole eq 'ROLE_STAFF' }">
				<label> <input type="checkbox" name="isNotice" value="true" />
					ê³µì§€ì‚¬í•­ìœ¼ë¡œ ë“±ë¡
				</label>
			</c:if>

			<div class="form-group">
				<label for="scheduleTitle">ì¼ì • ì œëª© *</label>
				<form:input path="scheduleTitle" id="scheduleTitle"
					cssClass="form-control" required="required"
					placeholder="ì¼ì • ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" />
				<form:errors path="scheduleTitle" cssClass="error" />
			</div>

			<div class="form-group">
				<label for="scheduleType">ì¼ì • ìœ í˜• *</label>
				<form:select path="type.scheduleTypeNo" id="scheduleType"
					cssClass="form-control" required="required">
					<form:option value="" label="-- ì¼ì • ìœ í˜•ì„ ì„ íƒí•˜ì„¸ìš” --" />
					<form:options items="${scheduleTypes}" itemValue="scheduleTypeNo"
						itemLabel="scheduleTypeName" />
				</form:select>
				<form:errors path="type.scheduleTypeNo" cssClass="error" />
			</div>

			<div class="datetime-group">
				<div class="form-group">
					<label for="startDate">ì‹œì‘ì¼ *</label>
					<form:input path="startDate" id="startDate" type="date"
						cssClass="form-control" required="required" />
					<form:errors path="startDate" cssClass="error" />
				</div>

				<div class="form-group">
					<label for="endDate">ì¢…ë£Œì¼ *</label>
					<form:input path="endDate" id="endDate" type="date"
						cssClass="form-control" required="required" />
					<form:errors path="endDate" cssClass="error" />
				</div>
			</div>

			<div class="datetime-group">
				<div class="form-group">
					<label for="startTime">ì‹œì‘ ì‹œê°„</label>
					<form:input path="startTime" id="startTime" type="time"
						cssClass="form-control" />
					<form:errors path="startTime" cssClass="error" />
				</div>

				<div class="form-group">
					<label for="endTime">ì¢…ë£Œ ì‹œê°„</label>
					<form:input path="endTime" id="endTime" type="time"
						cssClass="form-control" />
					<form:errors path="endTime" cssClass="error" />
				</div>
			</div>

			<div class="form-group">
				<label for="scheduleDesp">ì„¤ëª…</label>
				<form:textarea path="scheduleDesp" id="scheduleDesp"
					cssClass="form-control" placeholder="ì¼ì •ì— ëŒ€í•œ ìƒì„¸ ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”" />
				<form:errors path="scheduleDesp" cssClass="error" />
			</div>
		</form:form>
	</div>
	<div class="modal-footer">
	<button type="button" onclick="fillDemoSchedule()" class="btn btn-secondary">
    ë°ëª¨ ì¼ì • ì…ë ¥
  </button>
  <button type="button" onclick="closeModal()" class="btn" style="background-color: #6d6dde; color: white;">
    ì·¨ì†Œ
  </button>
  <button type="submit" form="scheduleForm" id="submitBtn" class="btn" style="background-color: #2563eb; color: white;">
    ë“±ë¡
  </button>
</div>
</div>

<!-- ì¼ì • ìƒì„¸ íŒì—… -->
<div id="schedulePopup" style="width:auto;">
	<div class="popup-header">
		<h3>ì¼ì • ìƒì„¸ì •ë³´</h3>
	</div>
	<div class="popup-body">
		<div id="popupContent"></div>
	</div>
	<div class="popup-footer">
		<button id="editBtn" class="btn btn-primary">ìˆ˜ì •</button>
		<button id="deleteBtn" class="btn btn-danger">ì‚­ì œ</button>
		<button onclick="closePopup()" class="btn btn-secondary">ë‹«ê¸°</button>
	</div>
</div>

<script>
	const loginUserNo = '${userNo}';
	let calendar;
	let currentScheduleId = null;
	
	document.addEventListener('DOMContentLoaded', function () {
		const calendarEl = document.getElementById('calendar');
	
		calendar = new FullCalendar.Calendar(calendarEl, {
		    initialView: 'dayGridMonth',
		    locale: 'ko',
		    height: 'auto',
		    headerToolbar: {
		        left: 'prev,next today',
		        center: 'title',
		        right: 'dayGridMonth'
		    },
		    // ë‚ ì§œ í´ë¦­ ì´ë²¤íŠ¸ - ì„ íƒí•œ ë‚ ì§œë¥¼ ì‹œì‘ì¼ê³¼ ì¢…ë£Œì¼ë¡œ ì„¤ì •
		    dateClick: function(info) {
		        console.log('í´ë¦­í•œ ë‚ ì§œ:', info.dateStr);
		        
		        // í¼ì„ ì´ˆê¸°í™”
		        resetForm();
		        
		        // í´ë¦­í•œ ë‚ ì§œë¥¼ ì‹œì‘ì¼ê³¼ ì¢…ë£Œì¼ë¡œ ì„¤ì •
		        document.getElementById("startDate").value = info.dateStr;
		        document.getElementById("endDate").value = info.dateStr;
		        
		        // ëª¨ë‹¬ ì—´ê¸°
		        openModal();
		    },
		    events: {
		    	url: '/schedule.do/list',
		        method: 'GET',
		        eventDataTransform: function (event) {
		            console.log("event color", event.backgroundColor);
		            return {
		                id: event.id,
		                title: event.title,
		                start: event.start,
		                end: event.end,
		                backgroundColor: event.backgroundColor,
		                borderColor: event.borderColor,
		                extendedProps: {
		                    startTime: event.startTime,
		                    endTime: event.endTime,
		                    scheduleDesp: event.scheduleDesp,
		                    type: event.type
		                }
		            };
		        }
		    },
		    eventClick: function (info) {
		        currentScheduleId = info.event.id;

		        fetch("/schedule.do/" + currentScheduleId)
		            .then(res => res.json())
		            .then(dt => {
		                console.log("data>>>>", dt);
						
		                const content = 
		                    "<strong>ì œëª©: " + (dt.scheduleTitle || '') + "</strong><br>" +
		                    "<strong>ì‹œì‘ì¼: " + (dt.startDate || '') + "</strong><br>" +
		                    "<strong>ì¢…ë£Œì¼: " + (dt.endDate || '') + "</strong><br>" +
		                    "<strong>ì‹œê°„: " + (dt.startTime || 'ì‹œê°„ ì—†ìŒ') + " ~ " + (dt.endTime || 'ì‹œê°„ ì—†ìŒ') + "</strong><br>" +
		                    "<strong>ìœ í˜•: " + (dt.type ? dt.type.scheduleTypeName : 'ì—†ìŒ') + "</strong><br>" +
		                    "<strong>ì„¤ëª…: " + (dt.scheduleDesp || 'ì„¤ëª… ì—†ìŒ') + "</strong><br>";
		                document.getElementById("popupContent").innerHTML = content;
		             // ìˆ˜ì • ë²„íŠ¼ í‘œì‹œ ì—¬ë¶€
		                if (dt.user.userNo === loginUserNo) {
		                  document.getElementById("editBtn").style.display = "inline-block";
		                  document.getElementById("deleteBtn").style.display = "inline-block";
		                } else {
		                  document.getElementById("editBtn").style.display = "none";
		                  document.getElementById("deleteBtn").style.display = "none";
		                }
		                document.getElementById("schedulePopup").style.display = "block";
		                document.getElementById("modalOverlay").style.display = "block";
		            });
		    }
		});
	
		calendar.render();

		// ìƒˆ ì¼ì • ë“±ë¡ ë²„íŠ¼
		document.getElementById("addScheduleBtn").addEventListener("click", function () {
			resetForm();
			openModal();
		});

		// ëª¨ë‹¬ ì˜¤ë²„ë ˆì´ í´ë¦­ ì‹œ ëª¨ë‹¬ ë‹«ê¸°
		document.getElementById("modalOverlay").addEventListener("click", function () {
			closeModal();
			closePopup();
		});
	
		// ìˆ˜ì • ë²„íŠ¼
		document.getElementById("editBtn").addEventListener("click", function () {
		    fetch("/schedule.do/" + currentScheduleId)
		        .then(res => res.json())
		        .then(data => {
		            document.getElementById("scheduleNo").value = data.scheduleNo || '';
		            document.getElementById("scheduleTitle").value = data.scheduleTitle || '';
		            document.getElementById("startDate").value = data.startDate || '';
		            document.getElementById("endDate").value = data.endDate || '';
		            document.getElementById("startTime").value = data.startTime || '';
		            document.getElementById("endTime").value = data.endTime || '';
		            document.getElementById("scheduleType").value = (data.type ? data.type.scheduleTypeNo : '') || '';
		            document.getElementById("scheduleDesp").value = data.scheduleDesp || '';
		            document.getElementById("formMode").value = "update";
		            document.getElementById("submitBtn").textContent = "ìˆ˜ì •";
		            document.getElementById("modalTitle").textContent = "ì¼ì • ìˆ˜ì •";
		            
		            closePopup();
		            openModal();
		        });
		});

		// ì‚­ì œ ë²„íŠ¼
		document.getElementById("deleteBtn").addEventListener("click", function () {
		    if (confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
		        fetch("/schedule.do/" + currentScheduleId, {
		            method: 'DELETE'
		        })
		        .then(res => res.json())
		        .then(result => {
		            if (result.result === 'success') {
		                alert("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
		                calendar.refetchEvents();
		            } else {
		                alert("ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
		            }
		        });
		        closePopup();
		    }
		});
		
		// í•„í„° ê²€ìƒ‰ ë²„íŠ¼
		document.getElementById("filterBtn").addEventListener("click", function () {
			const scheduleTypeNo = document.getElementById("filterType").value;
			const startDate = document.getElementById("filterStart").value;
			const endDate = document.getElementById("filterEnd").value;

			calendar.getEventSources().forEach(source => source.remove());

			calendar.addEventSource({
				url: "/schedule.do/list",
				method: "GET",
				extraParams: {
					scheduleTypeNo: scheduleTypeNo,
					startDate: startDate,
					endDate: endDate
				},
				failure: function () {
					alert("ì¼ì • ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
				}
			});
		});
		
		// í•„í„° ì´ˆê¸°í™” ë²„íŠ¼
		document.getElementById("resetFilterBtn").addEventListener("click", function () {
			document.getElementById("filterType").value = "";
			document.getElementById("filterStart").value = "";
			document.getElementById("filterEnd").value = "";

			calendar.getEventSources().forEach(source => source.remove());

			calendar.addEventSource({
				url: "/schedule.do/list",
				method: "GET",
				failure: function () {
					alert("ì¼ì • ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
				}
			});
		});

		// ì‹œì‘ì¼ ë³€ê²½ ì‹œ ì¢…ë£Œì¼ ìë™ ì„¤ì •
		document.getElementById("startDate").addEventListener("change", function() {
			const startDate = this.value;
			const endDateInput = document.getElementById("endDate");
			
			// ì¢…ë£Œì¼ì´ ì‹œì‘ì¼ë³´ë‹¤ ë¹ ë¥´ë©´ ì‹œì‘ì¼ê³¼ ê°™ê²Œ ì„¤ì •
			if (endDateInput.value && endDateInput.value < startDate) {
				endDateInput.value = startDate;
			}
			
			// ì¢…ë£Œì¼ì´ ë¹„ì–´ìˆìœ¼ë©´ ì‹œì‘ì¼ê³¼ ê°™ê²Œ ì„¤ì •
			if (!endDateInput.value) {
				endDateInput.value = startDate;
			}
		});
	});
	
	function openModal() {
	    document.getElementById("scheduleModal").style.display = "block";
	    document.getElementById("modalOverlay").style.display = "block";
	}
	
	function closeModal() {
	    document.getElementById("scheduleModal").style.display = "none";
	    document.getElementById("modalOverlay").style.display = "none";
	}
	
	function closePopup() {
	    document.getElementById("schedulePopup").style.display = "none";
	    document.getElementById("modalOverlay").style.display = "none";
	}
	
	// í¼ ì´ˆê¸°í™” í•¨ìˆ˜
	function resetForm() {
		document.getElementById("scheduleNo").value = "";
		document.getElementById("scheduleTitle").value = "";
		document.getElementById("startDate").value = "";
		document.getElementById("endDate").value = "";
		document.getElementById("startTime").value = "";
		document.getElementById("endTime").value = "";
		document.getElementById("scheduleType").value = "";
		document.getElementById("scheduleDesp").value = "";
		document.getElementById("formMode").value = "insert";
		document.getElementById("submitBtn").textContent = "ë“±ë¡";
		document.getElementById("modalTitle").textContent = "ì¼ì • ë“±ë¡";
	}

</script>


<c:if test="${not empty errorMessage}">
	<script>
       alert("${errorMessage}");
   </script>
</c:if>